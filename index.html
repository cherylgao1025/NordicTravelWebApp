<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂåóÊ≠êÊ•µÂÖâ‰πãÊóÖ (‰øÆÊ≠£Áâà)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // ==========================================
        // üö® CONFIG AREA üö®
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDgRMrlKcBhj5_zkK3YhD24DLxmm3tEzoU",
            authDomain: "nordictravel-6feb6.firebaseapp.com",
            projectId: "nordictravel-6feb6",
            storageBucket: "nordictravel-6feb6.firebasestorage.app",
            messagingSenderId: "789294490352",
            appId: "1:789294490352:web:cc4b3570743ece12db9835",
            measurementId: "G-J48HZ2031Q",
            databaseURL: "https://nordictravel-6feb6-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };

        const GOOGLE_MAPS_API_KEY = "AIzaSyBT3is8sUrQfnLzrrde8ADK4cPx3_tImSo";
        // ==========================================

        tailwind.config = {
            theme: {
                extend: { 
                    colors: { primary: '#3B82F6', secondary: '#10B981', dark: '#1F2937', light: '#F3F4F6' },
                    boxShadow: { 'up': '0 -4px 10px -1px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #google-map { width: 100%; height: 100%; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* Â¢ûÂä†‰∏ÄÂÄã grab cursor ÊåáÁ§∫ÂèØ‰ª•ÊãñÊõ≥ */
        .cursor-grab { cursor: grab; }
        .cursor-grab:active { cursor: grabbing; }
    </style>
</head>
<body>

    <div id="app" class="fixed inset-0 flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden w-full z-0">
        
        <header class="bg-white px-5 py-4 flex justify-between items-center z-10 border-b border-gray-100 shrink-0">
            <div class="flex-1">
                <h1 class="text-xl font-bold text-gray-900 tracking-tight flex items-center">
                    {{ pageTitle }}
                    <span class="ml-2 text-[10px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded flex items-center shadow-sm">
                        <i class="fas fa-check-circle mr-1"></i>Â∑≤ÈÄ£Á∑ö
                    </span>
                </h1>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'itinerary'">{{ daysLeftText }}</p>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'expenses'">Á∏ΩÊîØÂá∫: {{ formatMoneyEuroWithTWD(totalExpense) }}</p>
            </div>
            
            <button v-if="currentTab !== 'map'" @click="openAddModal" class="w-10 h-10 rounded-full bg-blue-50 text-primary flex items-center justify-center hover:bg-blue-100 transition shadow-sm active:scale-95">
                <i class="fas fa-plus text-lg"></i>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50" ref="mainContainer">
            
            <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white z-50">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-3"></div>
                    <p class="text-sm text-gray-400">Ê≠£Âú®ËÆÄÂèñË≥áÊñôÂ∫´...</p>
                </div>
            </div>

            <div v-show="currentTab === 'itinerary'" class="pb-24">
                
                <div class="sticky top-0 bg-white/95 backdrop-blur z-20 shadow-sm border-b border-gray-100">
                    <div class="flex overflow-x-auto no-scrollbar py-3 px-2 space-x-2">
                        <button v-for="dateObj in uniqueDates" :key="dateObj.date"
                            @click="selectDate(dateObj.date)"
                            :class="['flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap', 
                                     selectedDate === dateObj.date ? 'bg-primary text-white shadow-md transform scale-105' : 'bg-gray-100 text-gray-500']">
                            {{ dateObj.display }}
                        </button>
                    </div>
                </div>

                <div class="px-4 py-4 space-y-4">
                    
                    <div @click="openWeatherSite" class="bg-gradient-to-r from-blue-600 to-blue-400 p-5 rounded-2xl text-white shadow-lg cursor-pointer transform transition active:scale-[0.98] relative overflow-hidden">
                        <div class="absolute right-0 top-0 opacity-10 text-9xl -mr-4 -mt-4"><i class="fas fa-cloud"></i></div>
                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center">
                                <i :class="['text-4xl mr-4', getWeatherIcon(currentWeather.condition)]"></i>
                                <div>
                                    <div class="text-xs font-medium opacity-90 mb-1 flex items-center">
                                        <i class="fas fa-map-marker-alt mr-1"></i> {{ currentWeather.city || 'Êú™Áü•Âú∞Èªû' }}
                                    </div>
                                    <div class="text-3xl font-bold">{{ currentWeather.temp }}</div>
                                    <div class="text-sm opacity-90">{{ currentWeather.conditionText }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm">Êü•ÁúãË©≥ÊÉÖ <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        </div>
                    </div>

                    <div v-if="uniqueDates.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fas fa-database text-4xl mb-3 opacity-30"></i>
                        <p>Ë≥áÊñôÂ∫´ÁõÆÂâçÊòØÁ©∫ÁöÑ</p>
                        <p class="text-xs mt-1">Ë´ãÈªûÊìäÂè≥‰∏äËßíÊñ∞Â¢ûË°åÁ®ã</p>
                    </div>
                    
                    <div v-else-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <p>ÈÄô‰∏ÄÂ§©Ê≤íÊúâË°åÁ®ã</p>
                    </div>

                    <div v-for="item in filteredItinerary" :key="item.id" class="relative pl-6 border-l-2 border-blue-100 last:border-0 pb-2">
                        <div class="absolute -left-[9px] top-3 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm"></div>
                        <div class="bg-white p-4 rounded-2xl card-shadow active:scale-[0.99] transition-transform duration-200">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-primary font-bold text-sm bg-blue-50 px-2 py-0.5 rounded">{{ item.time }}</span>
                                <div class="flex space-x-3 text-gray-400">
                                    <button @click.stop="editItem(item)" class="hover:text-primary"><i class="fas fa-pen text-xs"></i></button>
                                    <button @click.stop="deleteItem(item.id, 'itinerary')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.title }}</h3>
                            
                            <div v-if="item.location" class="flex items-center text-gray-500 text-sm mb-2 mt-2 cursor-pointer hover:text-blue-600 transition group" @click="jumpToMap(item.location)">
                                <i class="fas fa-map-marker-alt text-red-400 mr-2 group-hover:scale-110 transition-transform"></i>
                                <span class="underline decoration-dotted decoration-gray-400">{{ item.location }}</span>
                            </div>
                            
                            <p v-if="item.notes" class="text-gray-600 text-sm mt-2 bg-gray-50 p-2 rounded-lg leading-relaxed whitespace-pre-wrap">{{ item.notes }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'expenses'" class="pb-24">
                <div class="p-5 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div v-for="user in users" :key="user" class="bg-white p-3 rounded-xl card-shadow">
                            <div class="text-xs text-gray-500 mb-1">{{ user }}</div>
                            <div class="text-lg font-bold text-primary">{{ formatMoneyEuro(getUserPaid(user)) }}</div>
                        </div>
                    </div>

                    <div v-if="settlements.length" class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-green-800 flex items-center"><i class="fas fa-calculator mr-2"></i> ÂàÜÂ∏≥ÁµêÁÆó</h3>
                            <button @click="showSettlement = !showSettlement" class="text-green-600 text-sm">
                                <i :class="showSettlement ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                            </button>
                        </div>
                        <div v-if="showSettlement" class="space-y-2">
                            <div v-for="s in settlements" :key="s.from+s.to" class="flex items-center justify-between bg-white p-3 rounded-lg text-sm">
                                <div><span class="font-bold">{{ s.from }}</span> <i class="fas fa-arrow-right mx-1 text-gray-400"></i> <span class="font-bold">{{ s.to }}</span></div>
                                <span class="font-bold text-green-600">{{ formatMoneyEuro(s.amount) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div v-for="exp in sortedExpenses" :key="exp.id" class="bg-white p-4 rounded-xl card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ exp.title }}</h4>
                                    <div class="text-xs text-gray-500 mt-1">{{ exp.date }} ‚Ä¢ ‰ªòÊ¨æ: {{ exp.payer }}</div>
                                </div>
                                <button @click="deleteItem(exp.id, 'expenses')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-800">{{ formatMoneyEuroWithTWD(exp.amount) }}</div>
                                <div class="text-[10px] text-gray-400">ÂàÜÁµ¶: {{ exp.beneficiaries.join(', ') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="w-full h-full relative">
                <div id="google-map" class="w-full h-full bg-gray-200"></div>
                
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
                    <button @click="focusCurrentLocation" class="bg-white p-3 rounded-full shadow-lg text-blue-600 active:bg-gray-100">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>

                <div 
                    class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-up z-20 flex flex-col transition-all duration-300 ease-out"
                    :style="{ height: isBottomSheetOpen ? '70%' : '140px', paddingBottom: '20px' }"
                >
                    <div 
                        @click="toggleBottomSheet"
                        @touchstart="handleTouchStart"
                        @touchend="handleTouchEnd"
                        class="w-full h-[60px] flex items-center justify-between px-6 cursor-grab border-b border-gray-100 flex-shrink-0 touch-none bg-white rounded-t-3xl"
                    >
                        <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-10 h-1 bg-gray-300 rounded-full"></div>
                        
                        <h3 class="font-bold text-gray-800 mt-2">ÊâÄÊúâÂú∞Èªû ({{ uniqueLocations.length }})</h3>
                        <i :class="['fas text-gray-400 transition-transform mt-2', isBottomSheetOpen ? 'fa-chevron-down' : 'fa-chevron-up']"></i>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
                        <p v-if="uniqueLocations.length === 0" class="text-center text-gray-400 text-sm py-4">ÁÑ°Âú∞ÈªûË≥áÊñô</p>
                        
                        <div v-for="(loc, index) in uniqueLocations" :key="loc"
                            @click="selectLocation(loc)"
                            class="p-3 rounded-xl flex items-center justify-between cursor-pointer transition-all border"
                            :class="selectedLocation === loc ? 'bg-blue-50 border-blue-500' : 'bg-white border-transparent hover:bg-gray-100'">
                            
                            <div class="flex items-center overflow-hidden">
                                <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0"
                                      :class="{'bg-blue-500 text-white': selectedLocation === loc}">
                                    {{ index + 1 }}
                                </span>
                                <span class="truncate font-medium text-sm" :class="selectedLocation === loc ? 'text-blue-700' : 'text-gray-700'">{{ loc }}</span>
                            </div>
                            
                            <i v-if="selectedLocation === loc" class="fas fa-check text-blue-500"></i>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t border-gray-100 py-2 px-4 flex justify-around items-center shrink-0 pb-safe z-30">
            <button @click="switchTab('itinerary')" :class="['flex flex-col items-center py-2 px-4 transition', currentTab === 'itinerary' ? 'text-primary scale-105' : 'text-gray-400']">
                <i class="fas fa-calendar-alt text-xl mb-1"></i>
                <span class="text-xs font-medium">Ë°åÁ®ã</span>
            </button>
            <button @click="switchTab('expenses')" :class="['flex flex-col items-center py-2 px-4 transition', currentTab === 'expenses' ? 'text-primary scale-105' : 'text-gray-400']">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs font-medium">ÂàÜÂ∏≥</span>
            </button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center py-2 px-4 transition', currentTab === 'map' ? 'text-primary scale-105' : 'text-gray-400']">
                <i class="fas fa-map text-xl mb-1"></i>
                <span class="text-xs font-medium">Âú∞Âúñ</span>
            </button>
        </nav>

        <div v-if="showAddModal" class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" @click.self="closeModal">
            <div class="bg-white w-full rounded-t-3xl p-6 pb-safe slide-up">
                <h2 class="text-xl font-bold mb-4">{{ currentTab === 'itinerary' ? (isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã') : 'Êñ∞Â¢ûÊîØÂá∫' }}</h2>
                
                <div v-if="currentTab === 'itinerary'" class="space-y-3">
                    <input v-model="itineraryForm.date" type="date" class="w-full p-3 border rounded-xl bg-gray-50">
                    <div class="flex gap-2">
                        <input v-model="itineraryForm.time" type="time" class="w-1/3 p-3 border rounded-xl bg-gray-50">
                        <input v-model="itineraryForm.title" type="text" placeholder="Ê®ôÈ°å" class="w-2/3 p-3 border rounded-xl bg-gray-50">
                    </div>
                    <input v-model="itineraryForm.location" type="text" placeholder="Âú∞Èªû (Áî®ÊñºÂú∞Âúñ)" class="w-full p-3 border rounded-xl bg-gray-50">
                    <textarea v-model="itineraryForm.notes" rows="2" placeholder="ÂÇôË®ª" class="w-full p-3 border rounded-xl bg-gray-50"></textarea>
                    <button @click="saveItinerary" class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-2">ÂÑ≤Â≠ò</button>
                </div>

                <div v-else class="space-y-3">
                    <input v-model="expenseForm.title" type="text" placeholder="È†ÖÁõÆ" class="w-full p-3 border rounded-xl bg-gray-50">
                    <div class="flex gap-2">
                        <input v-model.number="expenseForm.amount" type="number" inputmode="decimal" step="0.01" placeholder="ÈáëÈ°ç (‚Ç¨)" class="w-1/2 p-3 border rounded-xl bg-gray-50">
                        <input v-model="expenseForm.date" type="date" class="w-1/2 p-3 border rounded-xl bg-gray-50">
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button v-for="u in users" :key="u" @click="expenseForm.payer = u" 
                            :class="['px-3 py-1 rounded-full text-sm border whitespace-nowrap', expenseForm.payer === u ? 'bg-primary text-white' : 'bg-white']">{{ u }}</button>
                    </div>
                    <button @click="saveExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-2">ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

        const App = {
            setup() {
                // Config Setup
                const config = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : firebaseConfig;
                if (!firebase.apps.length) firebase.initializeApp(config);
                
                // Realtime Database Reference
                const db = firebase.database();
                const itineraryRef = db.ref('itinerary');
                const expensesRef = db.ref('expenses');
                const auth = firebase.auth();

                // State
                const loading = ref(true);
                const currentTab = ref('itinerary');
                const showAddModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const showSettlement = ref(false);
                const selectedDate = ref('');
                
                // Map & Bottom Sheet State
                const isBottomSheetOpen = ref(false);
                const selectedLocation = ref(null);
                const mapLoaded = ref(false);

                // Touch handling variables
                let touchStartY = 0;
                let touchEndY = 0;

                const users = ['Han', 'Sylvia', 'Messi', 'Cheryl'];
                const EURO_TO_TWD = 34.5;
                
                const itineraryItems = ref([]);
                const expenses = ref([]);
                const itineraryForm = reactive({ date: '', time: '09:00', title: '', location: '', notes: '' });
                const expenseForm = reactive({ title: '', amount: '', date: '', payer: users[0], beneficiaries: [...users] });
                
                // [FIX 1] Â§©Ê∞£È†êË®≠ÁÇ∫ N/A
                const currentWeather = reactive({ temp: 'N/A', condition: 'unknown', city: 'N/A', conditionText: 'Êú™Áü•' });
                
                // Geolocation Marker Storage
                let currentUserMarker = null;

                let map = null;
                let markers = [];
                let geocoder = null;

                // --- Computed ---
                const pageTitle = computed(() => {
                    if (currentTab.value === 'itinerary') return 'Ë°åÁ®ãË¶èÂäÉ';
                    if (currentTab.value === 'expenses') return 'ÂàÜÂ∏≥Âä©Êâã';
                    return 'Âú∞ÂúñÂ∞éË¶Ω';
                });

                const uniqueDates = computed(() => {
                    const dates = new Set(itineraryItems.value.map(i => i.date));
                    return Array.from(dates).filter(d => d).sort().map(d => {
                        const dateObj = new Date(d);
                        return { 
                            date: d, 
                            display: `${dateObj.getMonth()+1}/${dateObj.getDate()} (${getDayName(d)})` 
                        };
                    });
                });

                const filteredItinerary = computed(() => itineraryItems.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
                const uniqueLocations = computed(() => [...new Set(itineraryItems.value.filter(i => i.location).map(i => i.location))]);
                const totalExpense = computed(() => expenses.value.reduce((s, i) => s + (Number(i.amount)||0), 0));
                const sortedExpenses = computed(() => [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)));

                const daysLeftText = computed(() => {
                    if(!selectedDate.value) return '';
                    const index = uniqueDates.value.findIndex(d => d.date === selectedDate.value);
                    return index >= 0 ? `Day ${index + 1}` : '';
                });
                
                const settlements = computed(() => {
                    const bal = {}; users.forEach(u => bal[u] = 0);
                    expenses.value.forEach(e => {
                        const share = e.amount / e.beneficiaries.length;
                        bal[e.payer] += e.amount;
                        e.beneficiaries.forEach(b => bal[b] -= share);
                    });
                    const d = [], c = [];
                    for(let u in bal) { if(bal[u] < -0.01) d.push({u, a:-bal[u]}); else if(bal[u] > 0.01) c.push({u, a:bal[u]}); }
                    const res = [];
                    let i=0, j=0;
                    while(i<d.length && j<c.length) {
                        const amt = Math.min(d[i].a, c[j].a);
                        res.push({from: d[i].u, to: c[j].u, amount: amt});
                        d[i].a -= amt; c[j].a -= amt;
                        if(d[i].a < 0.01) i++; if(c[j].a < 0.01) j++;
                    }
                    return res;
                });

                const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('zh-TW', { weekday: 'short' }).replace('ÊòüÊúü', 'ÈÄ±');

                // --- Methods ---
                const snapshotToArray = (snap) => {
                    const list = [];
                    snap.forEach(childSnapshot => {
                        list.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    return list;
                };

                onMounted(() => {
                    if (typeof __initial_auth_token !== 'undefined') auth.signInWithCustomToken(__initial_auth_token);
                    else auth.signInAnonymously();

                    itineraryRef.on('value', s => {
                        itineraryItems.value = snapshotToArray(s);
                        loading.value = false;
                        if (!selectedDate.value && uniqueDates.value.length > 0) {
                            selectedDate.value = uniqueDates.value[0].date;
                        }
                        updateWeather();
                    });
                    expensesRef.on('value', s => expenses.value = snapshotToArray(s));

                    if (GOOGLE_MAPS_API_KEY) {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
                        script.async = true;
                        window.initMap = initMap;
                        document.head.appendChild(script);
                    }
                });

                const initMap = () => {
                    geocoder = new google.maps.Geocoder();
                    mapLoaded.value = true;
                    if(currentTab.value === 'map') renderMap();
                };

                const renderMap = () => {
                    if(!mapLoaded.value) return;
                    nextTick(() => {
                        const mapEl = document.getElementById('google-map');
                        if(mapEl) {
                            if(!map) {
                                map = new google.maps.Map(mapEl, { center: { lat: 60, lng: 10 }, zoom: 5, disableDefaultUI: true });
                            }
                            updateMapMarkers();
                            google.maps.event.trigger(map, 'resize');
                        }
                    });
                };

                const updateMapMarkers = () => {
                    if(!map) return;
                    markers.forEach(m => m.setMap(null));
                    markers = [];
                    const bounds = new google.maps.LatLngBounds();
                    
                    uniqueLocations.value.forEach((loc, idx) => {
                        geocoder.geocode({ address: loc }, (res, status) => {
                            if(status === 'OK') {
                                const pos = res[0].geometry.location;
                                const marker = new google.maps.Marker({
                                    map, position: pos, 
                                    label: { text: (idx+1)+"", color: "white" }
                                });
                                marker.addListener('click', () => selectLocation(loc));
                                markers.push(marker);
                                bounds.extend(pos);
                                map.fitBounds(bounds);
                            }
                        });
                    });
                };

                const focusMap = (loc) => {
                    if(!map) return;
                    geocoder.geocode({ address: loc }, (res, status) => {
                        if(status === 'OK') {
                            map.setCenter(res[0].geometry.location);
                            map.setZoom(15);
                        }
                    });
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if(tab === 'map') {
                        isBottomSheetOpen.value = false;
                        setTimeout(renderMap, 100); 
                    }
                };

                // [FIX 2] Bottom Sheet Logic
                const toggleBottomSheet = () => {
                    isBottomSheetOpen.value = !isBottomSheetOpen.value;
                }
                
                const selectLocation = (loc) => {
                    selectedLocation.value = loc;
                    focusMap(loc);
                    // ÈªûÊìäÂú∞ÈªûÂæå‰∏çÂÆåÂÖ®ÈóúÈñâÔºåËÄåÊòØÁ∏ÆÂ∞èÂà∞Â∫ïÈÉ®ÔºåÊñπ‰æøÁúãÂú∞Âúñ
                    isBottomSheetOpen.value = false; 
                };
                
                const handleTouchStart = (e) => {
                    touchStartY = e.touches[0].clientY;
                };
                
                const handleTouchEnd = (e) => {
                    touchEndY = e.changedTouches[0].clientY;
                    handleSwipe();
                };
                
                const handleSwipe = () => {
                    const diff = touchStartY - touchEndY;
                    if (Math.abs(diff) > 30) { // ÈñÄÊ™ªÂÄº
                        if (diff > 0) {
                            // Âêë‰∏äÊªëÂãï -> Â±ïÈñã
                            isBottomSheetOpen.value = true;
                        } else {
                            // Âêë‰∏ãÊªëÂãï -> Êî∂Âêà
                            isBottomSheetOpen.value = false;
                        }
                    }
                };

                // [FIX 1] Weather Logic
                const updateWeather = () => {
                    // Â¶ÇÊûúÊ≤íÊúâË°åÁ®ãË≥áÊñôÔºåÈáçÁΩÆÁÇ∫ N/A
                    if(!filteredItinerary.value.length) {
                        currentWeather.city = 'N/A';
                        currentWeather.temp = 'N/A';
                        currentWeather.condition = 'unknown';
                        currentWeather.conditionText = 'ÁÑ°Ë≥áÊñô';
                        return;
                    }
                    
                    // ÂèñÂæóÁ¨¨‰∏ÄÂÄãÂú∞ÈªûÂêçÁ®±
                    const loc = filteredItinerary.value[0].location;
                    const city = loc ? loc.split(',')[0] : 'N/A';
                    currentWeather.city = city;
                    
                    // Âõ†ÁÇ∫Ê≤íÊúâ Weather API KeyÔºåÈÄôË£°Âö¥Ê†ºÈÅµÂÆàÊåáÁ§∫Ôºö
                    // ‰∏çÁµ¶ÂÅáË≥áÊñô„ÄÇÂ¶ÇÊûúÊ≤íÊúâÁúüÂØ¶ APIÔºåÂ∞±È°ØÁ§∫ N/A„ÄÇ
                    // ÁÇ∫‰∫Ü‰∏çËÆìÁï´Èù¢Â§™ÈÜúÔºåÈÄôË£°‰øùÁïôË≥áÊñôÁµêÊßãÔºå‰ΩÜÊï∏ÂÄºË®≠ÁÇ∫ N/A„ÄÇ
                    currentWeather.temp = 'N/A';
                    currentWeather.condition = 'unknown';
                    currentWeather.conditionText = 'ÁÑ°Ê≥ïÂèñÂæó';
                };

                // UI Helpers
                const selectDate = (d) => { selectedDate.value = d; updateWeather(); };
                const openAddModal = () => { 
                    itineraryForm.date = selectedDate.value || new Date().toISOString().split('T')[0]; 
                    showAddModal.value = true; 
                    if(currentTab.value === 'expenses') expenseForm.date = selectedDate.value;
                };
                const closeModal = () => { showAddModal.value = false; isEditing.value = false; editingId.value = null; };
                
                const saveItinerary = async () => {
                    if(!itineraryForm.title) return;
                    if(isEditing.value) await itineraryRef.child(editingId.value).update({...itineraryForm});
                    else await itineraryRef.push({...itineraryForm});
                    closeModal();
                };
                
                const saveExpense = async () => {
                    if(!expenseForm.title) return;
                    await expensesRef.push({...expenseForm});
                    closeModal();
                };

                const deleteItem = async (id, type) => {
                    if(confirm('Âà™Èô§?')) await (type === 'itinerary' ? itineraryRef : expensesRef).child(id).remove();
                };

                const editItem = (item) => {
                    Object.assign(itineraryForm, item);
                    isEditing.value = true; editingId.value = item.id;
                    showAddModal.value = true;
                };

                const formatMoneyEuro = (v) => "‚Ç¨" + v.toFixed(2);
                const formatMoneyEuroWithTWD = (v) => `‚Ç¨${v.toFixed(2)} (~NT$${Math.round(v*34)})`;
                const getWeatherIcon = (c) => {
                    if (c === 'snow') return 'fas fa-snowflake';
                    if (c === 'rain') return 'fas fa-cloud-showers-heavy';
                    if (c === 'clear') return 'fas fa-sun';
                    return 'fas fa-cloud'; // Default
                };
                const getUserPaid = (u) => expenses.value.filter(e => e.payer === u).reduce((s,e) => s+Number(e.amount), 0);
                const jumpToMap = (loc) => { selectedLocation.value = loc; switchTab('map'); };
                const openWeatherSite = () => {
                    if (currentWeather.city && currentWeather.city !== 'N/A') {
                        window.open(`https://wttr.in/${currentWeather.city}`, '_blank');
                    }
                };

                // [FIX 4] Geolocation Implementation
                const focusCurrentLocation = () => {
                    if (!map) return;
                    
                    if (!navigator.geolocation) {
                        alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰ΩçÂäüËÉΩ");
                        return;
                    }

                    // È°ØÁ§∫ËÆÄÂèñ‰∏≠ÁãÄÊÖã (ÂèØÈÅ∏)
                    // alert("Ê≠£Âú®ÂÆö‰Ωç‰∏≠..."); 

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            // ÁßªÂãïÂú∞Âúñ‰∏≠ÂøÉ
                            map.setCenter(pos);
                            map.setZoom(15);

                            // Â¶ÇÊûúÂ∑≤Á∂ìÊúâËàäÁöÑÂÆö‰ΩçÊ®ôË®òÔºåÂÖàÁßªÈô§
                            if (currentUserMarker) {
                                currentUserMarker.setMap(null);
                            }

                            // Êñ∞Â¢û‰∏ÄÂÄãËóçËâ≤ÂúìÈªûÊ®ôË®ò (‰ΩøÁî® SVG Áπ™Ë£Ω‰∏ÄÂÄãËóçÈªû)
                            currentUserMarker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                title: "ÁèæÂú®‰ΩçÁΩÆ",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "white",
                                    strokeWeight: 2,
                                },
                            });
                        },
                        (error) => {
                            console.error("Error getting location: ", error);
                            let msg = "ÂÆö‰ΩçÂ§±Êïó";
                            switch(error.code) {
                                case error.PERMISSION_DENIED: msg = "ÊÇ®ÊãíÁµï‰∫ÜÂÆö‰ΩçÊ¨äÈôê"; break;
                                case error.POSITION_UNAVAILABLE: msg = "ÁÑ°Ê≥ïÂÅµÊ∏¨ÁõÆÂâç‰ΩçÁΩÆ"; break;
                                case error.TIMEOUT: msg = "ÂÆö‰ΩçÈÄæÊôÇ"; break;
                            }
                            alert(msg);
                        },
                        {
                            enableHighAccuracy: true, // Ë¶ÅÊ±ÇÈ´òÁ≤æÊ∫ñÂ∫¶
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                };

                return {
                    loading, currentTab, pageTitle, daysLeftText, users, showAddModal, isEditing, showSettlement,
                    itineraryItems, expenses, itineraryForm, expenseForm, currentWeather,
                    uniqueDates, selectedDate, filteredItinerary, uniqueLocations, sortedExpenses, totalExpense, settlements,
                    isBottomSheetOpen, selectedLocation,
                    selectDate, switchTab, openAddModal, closeModal, saveItinerary, saveExpense, deleteItem, editItem,
                    formatMoneyEuro, formatMoneyEuroWithTWD, getWeatherIcon, getUserPaid, jumpToMap, openWeatherSite, selectLocation, 
                    focusCurrentLocation, toggleBottomSheet, handleTouchStart, handleTouchEnd
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>