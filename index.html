<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æ­æ¥µå…‰ä¹‹æ—… (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // ğŸš¨ CONFIG AREA - è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„é‡‘é‘° ğŸš¨
        // ==========================================
        
        // 1. å¡«å…¥ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDgRMrlKcBhj5_zkK3YhD24DLxmm3tEzoU",
            authDomain: "nordictravel-6feb6.firebaseapp.com",
            projectId: "nordictravel-6feb6",
            storageBucket: "nordictravel-6feb6.firebasestorage.app",
            messagingSenderId: "789294490352",
            appId: "1:789294490352:web:cc4b3570743ece12db9835",
            measurementId: "G-J48HZ2031Q"
};

        // 2. å¡«å…¥ Google Maps API Key
        const GOOGLE_MAPS_API_KEY = "AIzaSyBT3is8sUrQfnLzrrde8ADK4cPx3_tImSo";
        // ==========================================

        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#3B82F6', secondary: '#10B981', dark: '#1F2937', light: '#F3F4F6', accent: '#8B5CF6' } }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .weather-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Google Maps Container */
        #google-map { width: 100%; height: 100%; }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col bg-gray-100">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden w-full">
        
        <header class="bg-white px-5 py-4 flex justify-between items-center z-10 border-b border-gray-100 shrink-0">
            <div class="flex-1">
                <h1 class="text-xl font-bold text-gray-900 tracking-tight flex items-center">
                    {{ pageTitle }}
                    <span class="ml-2 text-[10px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded flex items-center shadow-sm">
                        <i class="fas fa-cloud mr-1"></i>å·²åŒæ­¥
                    </span>
                </h1>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'itinerary'">{{ daysLeftText }}</p>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'expenses'">ç¸½æ”¯å‡º: {{ formatMoneyEuroWithTWD(totalExpense) }}</p>
            </div>
            
            <button v-if="currentTab !== 'map'" @click="showAddModal = true" class="w-10 h-10 rounded-full bg-blue-50 text-primary flex items-center justify-center hover:bg-blue-100 transition shadow-sm active:scale-95">
                <i class="fas fa-plus text-lg"></i>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50">
            
            <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white z-50">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-3"></div>
                    <p class="text-sm text-gray-400">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
                </div>
            </div>

            <div v-if="currentTab === 'itinerary'" class="pb-24">
                <div class="sticky top-0 bg-white/95 backdrop-blur z-10 shadow-sm border-b border-gray-100">
                    <div class="flex overflow-x-auto no-scrollbar py-3 px-2 space-x-2">
                        <button v-for="date in uniqueDates" :key="date.date"
                            @click="selectedDate = date.date; scrollToTop()"
                            :class="['flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap', 
                                     selectedDate === date.date ? 'bg-primary text-white shadow-md transform scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']">
                            {{ date.display }}
                        </button>
                    </div>

                    <div v-if="currentWeather.temp !== 'N/A'" @click="openWeatherSite" class="flex items-center mx-4 my-2 p-3 bg-blue-50 rounded-xl cursor-pointer hover:bg-blue-100 transition active:scale-[0.98]">
                        <i :class="['text-3xl mr-3 weather-icon', getWeatherIcon(currentWeather.condition)]"></i>
                        <div class="text-left flex-1">
                            <div class="text-sm font-medium text-gray-800">{{ currentWeather.city }} - ä»Šæ—¥å¤©æ°£</div>
                            <div class="text-xl font-bold text-gray-900">{{ currentWeather.temp }}Â°C</div>
                        </div>
                        <i class="fas fa-external-link-alt text-gray-400 text-sm"></i>
                    </div>
                </div>

                <div class="px-4 py-6 space-y-4">
                    <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fas fa-snowflake text-4xl mb-3 opacity-30"></i>
                        <p>é»æ“Šå³ä¸Šè§’ + æ–°å¢è¡Œç¨‹</p>
                    </div>

                    <div v-for="item in filteredItinerary" :key="item.id" class="relative pl-6 border-l-2 border-blue-100 last:border-0">
                        <div class="absolute -left-[9px] top-3 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm"></div>
                        <div class="bg-white p-4 rounded-2xl card-shadow active:scale-[0.99] transition-transform duration-200">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-primary font-bold text-sm bg-blue-50 px-2 py-0.5 rounded">{{ item.time }}</span>
                                <div class="flex space-x-3 text-gray-400">
                                    <button @click="editItem(item)" class="hover:text-primary"><i class="fas fa-pen text-xs"></i></button>
                                    <button @click="deleteItem(item.id, 'itinerary')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.title }}</h3>
                            <div v-if="item.location" class="flex items-center text-gray-500 text-sm mb-2 mt-2" @click="openGoogleMapQuery(item.location)">
                                <i class="fas fa-map-marker-alt text-red-400 mr-2"></i>
                                <span class="underline decoration-dotted decoration-gray-400">{{ item.location }}</span>
                            </div>
                            <p v-if="item.notes" class="text-gray-600 text-sm mt-2 bg-gray-50 p-2 rounded-lg leading-relaxed">{{ item.notes }}</p>
                            <button @click="openGoogleMapQuery(item.location || item.title)" class="mt-3 w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-medium flex items-center justify-center transition-colors">
                                <i class="fas fa-location-arrow mr-2"></i> å¤–éƒ¨å°èˆª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expenses'" class="pb-24">
                <div class="p-5 space-y-3">
                    <div class="space-y-3">
                        <div v-for="user in users" :key="user" class="bg-white p-3 rounded-xl card-shadow text-left flex justify-between items-center">
                            <div class="text-sm font-medium text-gray-500">{{ user }} ä»˜æ¬¾ç¸½é¡:</div>
                            <div class="text-xl font-bold text-primary">{{ formatMoneyEuro(getUserPaid(user)) }}</div>
                        </div>
                    </div>

                    <div v-if="settlements.length" class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-green-800 flex items-center"><i class="fas fa-calculator mr-2"></i> åˆ†å¸³çµç®—</h3>
                            <button @click="showSettlement = !showSettlement" class="text-green-600 text-sm hover:text-green-700">
                                <i :class="showSettlement ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                            </button>
                        </div>
                        <div v-if="showSettlement" class="space-y-2">
                            <div v-for="s in settlements" :key="s.from+s.to" class="flex items-center justify-between bg-white p-3 rounded-lg">
                                <div class="flex items-center">
                                    <span class="font-bold text-gray-700">{{ s.from }}</span>
                                    <i class="fas fa-arrow-right mx-3 text-green-500"></i>
                                    <span class="font-bold text-gray-700">{{ s.to }}</span>
                                </div>
                                <span class="font-bold text-green-600">{{ formatMoneyEuro(s.amount) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div v-for="exp in sortedExpenses" :key="exp.id" class="bg-white p-4 rounded-xl card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">{{ exp.title }}</h4>
                                    <div class="text-xs text-gray-500 mt-1 flex items-center">
                                        <i class="far fa-calendar mr-1"></i> {{ exp.date }}
                                    </div>
                                </div>
                                <button @click="deleteItem(exp.id, 'expenses')" class="text-gray-400 hover:text-red-500 ml-2">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <div class="text-sm">
                                    <span class="text-gray-500">ä»˜æ¬¾:</span>
                                    <span class="font-bold text-primary ml-1">{{ exp.payer }}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-800">{{ formatMoneyEuroWithTWD(exp.amount) }}</div>
                                    <div class="text-[10px] text-gray-400" v-if="exp.beneficiaries && exp.beneficiaries.length">
                                        åˆ†çµ¦ {{ exp.beneficiaries.join(', ') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'map'" class="h-full flex flex-col">
                <div class="shrink-0 h-1/3 overflow-y-auto no-scrollbar p-4 space-y-2 border-b border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">æ‰€æœ‰è¡Œç¨‹åœ°é» ({{ uniqueLocations.length }})</h3>
                    <div v-if="uniqueLocations.length === 0" class="text-center py-5 text-gray-400 text-sm">
                         <i class="fas fa-map-pin text-3xl mb-2 opacity-30"></i><p>å°šæœªæ–°å¢ä»»ä½•åœ°é»</p>
                    </div>
                    <button v-for="loc in uniqueLocations" :key="loc"
                        @click="focusMap(loc)"
                        class="w-full bg-white p-4 rounded-xl card-shadow flex items-center justify-between hover:bg-gray-50 active:scale-95 transition">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-red-400 text-xl mr-3"></i>
                            <span class="font-medium text-gray-700 text-left truncate">{{ loc }}</span>
                        </div>
                        <i class="fas fa-crosshairs text-gray-400 ml-2"></i>
                    </button>
                </div>
                
                <div class="flex-1 relative bg-gray-200">
                    <div id="google-map"></div>
                    <div v-if="!mapLoaded" class="absolute inset-0 flex items-center justify-center bg-gray-100/70 backdrop-blur-sm text-gray-500 font-medium">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mr-2"></div>
                        è¼‰å…¥åœ°åœ–ä¸­...
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t border-gray-100 py-2 px-4 flex justify-around items-center shrink-0 pb-safe">
            <button @click="switchTab('itinerary')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-calendar-alt text-xl mb-1"></i>
                <span class="text-xs font-medium">è¡Œç¨‹</span>
            </button>
            <button @click="switchTab('expenses')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'expenses' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs font-medium">åˆ†å¸³</span>
            </button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'map' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-map text-xl mb-1"></i>
                <span class="text-xs font-medium">åœ°åœ–</span>
            </button>
        </nav>

        <div v-if="showAddModal" @click.self="closeModal" class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn">
            <div class="bg-white w-full rounded-t-3xl p-6 pb-safe max-h-[85vh] overflow-y-auto slide-up">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-bold text-gray-800">{{ currentTab === 'itinerary' ? (isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹') : 'æ–°å¢æ”¯å‡º' }}</h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label><input v-model="itineraryForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ™‚é–“</label><input v-model="itineraryForm.time" type="time" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ¨™é¡Œ</label><input v-model="itineraryForm.title" type="text" placeholder="ä¾‹: æ–¯å¾·å“¥çˆ¾æ‘©èˆŠåŸå€" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">åœ°é»</label><input v-model="itineraryForm.location" type="text" placeholder="Gamla Stan, Stockholm" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label><textarea v-model="itineraryForm.notes" rows="3" placeholder="å¯é¸" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea></div>
                    <button @click="saveItinerary" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        {{ isEditing ? 'æ›´æ–°' : 'æ–°å¢' }}
                    </button>
                </div>

                <div v-if="currentTab === 'expenses'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">é …ç›®</label><input v-model="expenseForm.title" type="text" placeholder="ä¾‹: æ™šé¤" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡ (â‚¬ æ­å…ƒ)</label>
                        <input v-model.number="expenseForm.amount" @input="formatEuroAmount" type="number" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                        <p class="text-xs text-gray-500 mt-1">ç´„ç­‰æ–¼ {{ formatMoneyEuroWithTWD(expenseForm.amount || 0) }}</p>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label><input v-model="expenseForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾äºº</label>
                        <div class="flex gap-2">
                            <button v-for="user in users" :key="user" @click="expenseForm.payer = user" :class="['flex-1 py-2 rounded-xl font-medium transition', expenseForm.payer === user ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å—ç›Šäºº</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button v-for="user in users" :key="user" @click="toggleBeneficiary(user)" :class="['px-4 py-2 rounded-xl font-medium transition', expenseForm.beneficiaries.includes(user) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                        <button @click="toggleAllBeneficiaries" class="text-sm text-primary hover:underline">
                            {{ expenseForm.beneficiaries.length === users.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}
                        </button>
                    </div>
                    <button @click="saveExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        æ–°å¢æ”¯å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç¢ºä¿ Vue å‡½å¼è¢«æ­£ç¢ºè§£æ§‹
        const { createApp, ref, computed, reactive, onMounted, watch } = Vue;

        const App = {
            setup() {
                // --- Initialization ---
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                const itineraryRef = db.collection('itinerary');
                const expensesRef = db.collection('expenses');
                
                // --- State ---
                const loading = ref(true);
                const currentTab = ref('itinerary');
                const showAddModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const showSettlement = ref(false);
                const selectedDate = ref('2025-12-23');
                const users = ['Han', 'Sylvia', 'Messi', 'Cheryl']; // 2. äººå“¡åå–®
                const EURO_TO_TWD = 34.5; // 6. æ­å…ƒåŒ¯ç‡ (æ¨¡æ“¬)

                const itineraryItems = ref([]);
                const expenses = ref([]);
                const mapLoaded = ref(false); // åœ°åœ–è¼‰å…¥ç‹€æ…‹

                const itineraryForm = reactive({ date: '2025-12-23', time: '09:00', title: '', location: '', notes: '' });
                const expenseForm = reactive({ title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });

                // Weather (æ¨¡æ“¬æ•¸æ“š)
                const weather = reactive({ temp: null, condition: '', city: '' });
                const weatherData = {
                    '2025-12-20': { temp: 25, condition: 'sunny', city: 'Taipei' },
                    '2025-12-21': { temp: 0, condition: 'snow', city: 'Stockholm' },
                    '2025-12-22': { temp: -1, condition: 'light snow', city: 'Stockholm' },
                    '2025-12-23': { temp: -5, condition: 'cloudy', city: 'Helsinki' },
                    '2025-12-24': { temp: -8, condition: 'snow', city: 'Helsinki' }, 
                    '2026-01-03': { temp: 5, condition: 'cloudy', city: 'Copenhagen' },
                    '2026-01-04': { temp: 0, condition: 'mist', city: 'Beijing' },
                    '2026-01-05': { temp: 15, condition: 'sunny', city: 'Taipei' },
                };
                
                // Google Maps Objects
                let map = null;
                let markers = [];
                let geocoder = null;

                // --- Computed Properties ---
                const pageTitle = computed(() => {
                    if (currentTab.value === 'itinerary') return 'åŒ—æ­è¡Œç¨‹';
                    if (currentTab.value === 'expenses') return 'åˆ†å¸³åŠ©æ‰‹';
                    return 'åœ°é»å°èˆª';
                });

                const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('zh-TW', { weekday: 'short' }).replace('æ˜ŸæœŸ', 'é€±');

                // 5. æ—¥æœŸ Tab é¡¯ç¤ºèª¿æ•´ (åŒ…å« Dç·¨è™Ÿ)
                const uniqueDates = computed(() => {
                    const allDates = new Set(itineraryItems.value.map(i => i.date));
                    // ç¢ºä¿è‡³å°‘æœ‰é è¨­æ—¥æœŸï¼Œä»¥é˜² Firebase è¼‰å…¥æ…¢
                    ['2025-12-20', '2025-12-21', '2025-12-23', '2026-01-03', '2026-01-05'].forEach(d => allDates.add(d));

                    return Array.from(allDates).sort().map((date, index) => {
                        const dayNumber = index + 1;
                        const dayName = getDayName(date);
                        return {
                            date: date,
                            display: `${new Date(date).getMonth()+1}/${new Date(date).getDate()} (${dayName}) D${dayNumber}`
                        };
                    });
                });

                const currentWeather = computed(() => weatherData[selectedDate.value] || { temp: 'N/A', condition: 'cloudy', city: 'æœªçŸ¥' });
                const filteredItinerary = computed(() => itineraryItems.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((sum, i) => sum + (Number(i.amount)||0), 0));
                const sortedExpenses = computed(() => [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)));
                
                // 8. æ‰€æœ‰åœ°é»åˆ—è¡¨
                const uniqueLocations = computed(() => [...new Set(itineraryItems.value.filter(i => i.location).map(i => i.location))]);
                
                const settlements = computed(() => {
                    const balance = {}; 
                    users.forEach(p => balance[p] = 0);
                    expenses.value.forEach(e => {
                        const beneficiaries = Array.isArray(e.beneficiaries) ? e.beneficiaries : [];
                        if (!beneficiaries.length || e.amount <= 0) return;
                        balance[e.payer] += e.amount;
                        const split = e.amount / beneficiaries.length;
                        beneficiaries.forEach(b => balance[b] -= split);
                    });
                    
                    let debtors = Object.keys(balance).filter(p => balance[p] < -0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>a.a-b.a);
                    let creditors = Object.keys(balance).filter(p => balance[p] > 0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>b.a-a.a);
                    const res = [];
                    let i=0, j=0;
                    while(i<debtors.length && j<creditors.length) {
                        const amt = Math.min(Math.abs(debtors[i].a), creditors[j].a);
                        res.push({from:debtors[i].n, to:creditors[j].n, amount: parseFloat(amt.toFixed(2))});
                        debtors[i].a += amt; 
                        creditors[j].a -= amt;
                        if(Math.abs(debtors[i].a)<0.01) i++;
                        if(creditors[j].a<0.01) j++;
                    }
                    return res;
                });

                const daysLeftText = computed(() => {
                    const allDates = Array.from(new Set(itineraryItems.value.map(i => i.date))).sort();
                    const index = allDates.indexOf(selectedDate.value);
                    if (index === -1) return 'éè¡Œç¨‹æ—¥';
                    return `ç¬¬ ${index + 1} å¤©`;
                });

                // --- Data Listeners ---
                onMounted(() => {
                    // è¼‰å…¥ Google Maps è…³æœ¬
                    if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== "YOUR_GOOGLE_MAPS_API_KEY") {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
                        script.async = true;
                        script.defer = true;
                        document.head.appendChild(script);
                        window.initMap = initMap; // è¨­ç½®å…¨å±€å›èª¿
                    } else {
                        console.error("è«‹å¡«å¯« Google Maps API Key ä»¥å•Ÿç”¨åœ°åœ–åŠŸèƒ½ã€‚");
                    }
                    
                    // Firebase Real-time Listeners
                    itineraryRef.orderBy('date').orderBy('time').onSnapshot(snapshot => {
                        itineraryItems.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loading.value = false;
                        updateMapMarkers(); // è³‡æ–™æ›´æ–°æ™‚æ›´æ–°åœ°åœ–æ¨™è¨˜
                        if (!itineraryItems.value.some(i => i.date === selectedDate.value) && uniqueDates.value.length > 0) {
                            selectedDate.value = uniqueDates.value[0].date;
                        }
                    }, err => {
                        console.error("Firebase è¡Œç¨‹è¼‰å…¥å¤±æ•—: ", err);
                        loading.value = false;
                    });

                    expensesRef.orderBy('date', 'desc').onSnapshot(snapshot => {
                        expenses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    updateWeather(selectedDate.value);
                });
                
                watch(selectedDate, (newDate) => { updateWeather(newDate); });

                // --- Google Maps Logic ---
                const initMap = () => {
                    geocoder = new google.maps.Geocoder();
                    mapLoaded.value = true;
                };

                const renderMap = () => {
                    if (!mapLoaded.value) return; // Wait for script to load

                    if (!map && document.getElementById('google-map')) {
                        map = new google.maps.Map(document.getElementById('google-map'), {
                            center: { lat: 59.3293, lng: 18.0686 }, // æ–¯å¾·å“¥çˆ¾æ‘©
                            zoom: 10,
                            disableDefaultUI: true,
                            zoomControl: true,
                        });
                        updateMapMarkers();
                    } else if (map) {
                        updateMapMarkers();
                    }
                };

                const updateMapMarkers = () => {
                    if (!map || !geocoder) return;
                    markers.forEach(m => m.setMap(null));
                    markers = [];

                    const locs = uniqueLocations.value;
                    let bounds = new google.maps.LatLngBounds();
                    
                    if (locs.length === 0) {
                        if (map) map.setCenter({ lat: 59.3293, lng: 18.0686 });
                        return;
                    }

                    locs.forEach(address => {
                        geocoder.geocode({ address: address }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                const position = results[0].geometry.location;
                                const marker = new google.maps.Marker({
                                    map: map,
                                    position: position,
                                    title: address,
                                    animation: google.maps.Animation.DROP
                                });
                                
                                markers.push(marker);
                                bounds.extend(position);

                                // If only one location, center and zoom in
                                if (locs.length === 1 && map) {
                                    map.setCenter(position);
                                    map.setZoom(15);
                                } else if (locs.length > 1 && map) {
                                    // If multiple locations, fit all markers
                                    map.fitBounds(bounds);
                                }
                            }
                        });
                    });
                };
                
                // é»æ“Šåœ°é»åˆ—è¡¨é …ç›®æ™‚èšç„¦åœ°åœ–
                const focusMap = (address) => {
                    if(!map || !geocoder) {
                        alert("åœ°åœ–åŠŸèƒ½æœªå®Œå…¨è¼‰å…¥ï¼Œè«‹ç¨å€™ã€‚");
                        return;
                    }
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK') {
                            map.setCenter(results[0].geometry.location);
                            map.setZoom(15);
                        } else {
                             alert(`ç„¡æ³•æ‰¾åˆ°åœ°é»: ${address}`);
                        }
                    });
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if (tab === 'map') {
                        setTimeout(renderMap, 100); // ç¢ºä¿ DOM æ¸²æŸ“å¾Œå†åŸ·è¡Œåœ°åœ–é‚è¼¯
                    }
                };
                
                // --- CRUD Operations (ä½¿ç”¨ Firebase) ---
                const saveItinerary = async () => {
                    const item = { ...itineraryForm };
                    if (!item.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
                    try {
                        if (isEditing.value) {
                            await itineraryRef.doc(editingId.value).update(item);
                        } else {
                            // 4. æ–°å¢æ‚¨çš„è¡Œç¨‹ (åˆå§‹è³‡æ–™)
                            if (itineraryItems.value.length === 0) {
                                // é¦–æ¬¡æ–°å¢æ™‚ï¼Œè‹¥ç„¡è³‡æ–™ï¼Œå¯å°‡ä½¿ç”¨è€…è¡Œç¨‹ä½œç‚ºåˆå§‹æ•¸æ“šå¯«å…¥
                                const initialItinerary = [
                                    { date: '2025-12-20', time: '18:50', title: 'TPE âœ BKK èˆªç­', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', notes: 'TG635 (æ³°åœ‹åœ‹éš›èˆªç©º). 18:50 âœ 21:45 (æ›¼è°·)' },
                                    { date: '2025-12-21', time: '00:05', title: 'BKK âœ ARN èˆªç­', location: 'è˜‡å‡¡ç´å¸ƒåœ‹éš›æ©Ÿå ´ (BKK)', notes: 'TG960 (æ³°åœ‹åœ‹éš›èˆªç©º). 00:05 âœ 06:45 (æ–¯å¾·å“¥çˆ¾æ‘©)' },
                                    { date: '2025-12-23', time: '08:20', title: 'ARN âœ HEL èˆªç­ (èˆ‡æœ‹å‹æœƒåˆ)', location: 'æ–¯å¾·å“¥çˆ¾æ‘©é˜¿è˜­é”æ©Ÿå ´ (ARN)', notes: 'SK702 (åŒ—æ­èˆªç©ºSAS). 08:20 âœ 10:35 (èµ«çˆ¾è¾›åŸº)' },
                                    { date: '2026-01-03', time: '18:00', title: 'CPH âœ PEK èˆªç­ (å›ç¨‹)', location: 'å“¥æœ¬å“ˆæ ¹æ©Ÿå ´ (CPH)', notes: 'CA878 (ä¸­åœ‹åœ‹éš›èˆªç©º). 18:00 âœ 01/04 09:45 (åŒ—äº¬)' },
                                    { date: '2026-01-05', time: '08:20', title: 'PEK âœ TPE èˆªç­ (å›ç¨‹)', location: 'åŒ—äº¬é¦–éƒ½åœ‹éš›æ©Ÿå ´ (PEK)', notes: 'CA185 (ä¸­åœ‹åœ‹éš›èˆªç©º). 08:20 âœ 11:40 (å°åŒ—)' },
                                ];
                                // é¿å…é‡è¤‡å¯«å…¥ï¼šåªåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚å¯«å…¥é è¨­è¡Œç¨‹
                                for (const i of initialItinerary) {
                                    await itineraryRef.add(i);
                                }
                            }
                            await itineraryRef.add(item);
                        }
                        closeModal();
                    } catch (e) { alert("å„²å­˜è¡Œç¨‹å¤±æ•—: " + e.message); }
                };

                const saveExpense = async () => {
                    // 6. å¼·åˆ¶å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½
                    const amount = Number(parseFloat(expenseForm.amount).toFixed(2));
                    if (isNaN(amount) || amount <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                    
                    const item = { ...expenseForm, amount: amount };
                    if (!item.title) return alert("è«‹å¡«å¯«é …ç›®");
                    
                    try {
                        await expensesRef.add(item);
                        closeModal();
                    } catch (e) { alert("å„²å­˜æ”¯å‡ºå¤±æ•—: " + e.message); }
                };

                const deleteItem = async (id, collectionName) => {
                    if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) return;
                    try {
                        await db.collection(collectionName).doc(id).delete();
                    } catch (e) { alert("åˆªé™¤å¤±æ•—: " + e.message); }
                };

                // --- Helpers ---
                const scrollToTop = () => document.querySelector('main').scrollTop = 0;
                const formatMoneyEuro = (v) => new Intl.NumberFormat('en-US', {style:'currency', currency:'EUR', minimumFractionDigits:2, maximumFractionDigits:2}).format(v);
                
                // 6. æ­å…ƒè½‰å°å¹£é¡¯ç¤º
                const formatMoneyEuroWithTWD = (v) => {
                    const euro = parseFloat(v) || 0;
                    const twd = Math.round(euro * EURO_TO_TWD);
                    return `${formatMoneyEuro(euro)} (ç´„ NTD ${new Intl.NumberFormat('zh-TW', {maximumFractionDigits:0}).format(twd)})`;
                };
                
                const formatEuroAmount = () => {
                    // ç¢ºä¿è¼¸å…¥å€¼ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œä¸¦é™åˆ¶å°æ•¸é»å¾Œå…©ä½
                    let value = String(expenseForm.amount).replace(/[^0-9.]/g, '');
                    const parts = value.split('.');
                    if (parts.length > 1 && parts[1].length > 2) {
                        parts[1] = parts[1].substring(0, 2);
                        value = parts.join('.');
                    }
                    expenseForm.amount = value;
                };

                const openWeatherSite = () => window.open('https://wttr.in/Stockholm', '_blank');
                const getWeatherIcon = (condition) => {
                    if (condition.includes('sun') || condition.includes('clear')) return 'fas fa-sun text-yellow-400';
                    if (condition.includes('snow') || condition.includes('frost')) return 'fas fa-snowflake text-blue-200';
                    if (condition.includes('rain')) return 'fas fa-cloud-rain text-blue-500';
                    return 'fas fa-cloud text-gray-400';
                };
                const openGoogleMapQuery = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                const getUserPaid = (u) => expenses.value.filter(e => e.payer === u).reduce((s,e) => s+e.amount, 0);
                const toggleAllBeneficiaries = () => expenseForm.beneficiaries = expenseForm.beneficiaries.length === users.length ? [] : [...users];
                const toggleBeneficiary = (u) => { const i = expenseForm.beneficiaries.indexOf(u); i>-1 ? expenseForm.beneficiaries.splice(i,1) : expenseForm.beneficiaries.push(u); };
                
                const closeModal = () => {
                    showAddModal.value = false; isEditing.value = false; editingId.value = null;
                    // é‡è¨­è¡¨å–®
                    Object.assign(itineraryForm, { date: selectedDate.value, time: '09:00', title: '', location: '', notes: '' });
                    Object.assign(expenseForm, { title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });
                };

                const editItem = (item) => {
                    isEditing.value = true; editingId.value = item.id;
                    Object.assign(itineraryForm, { ...item });
                    currentTab.value = 'itinerary'; showAddModal.value = true;
                };

                return {
                    loading, currentTab, pageTitle, daysLeftText, users, showAddModal, isEditing, showSettlement, weather, currentWeather, mapLoaded,
                    uniqueDates, selectedDate, filteredItinerary, totalExpense, sortedExpenses, uniqueLocations, settlements,
                    itineraryForm, expenseForm,
                    scrollToTop, formatMoneyEuro, formatMoneyEuroWithTWD, openGoogleMapQuery, getUserPaid, toggleAllBeneficiaries, toggleBeneficiary, closeModal, editItem, saveItinerary, deleteItem, saveExpense, getWeatherIcon,
                    formatEuroAmount, switchTab, focusMap
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>