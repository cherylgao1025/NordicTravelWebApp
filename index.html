<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂåóÊ≠êÊ•µÂÖâ‰πãÊóÖ (v3 UIÂÑ™ÂåñÁâà)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ==========================================
        // üö® CONFIG AREA - Ë´ãÂú®ÈÄôË£°Â°´ÂÖ•ÊÇ®ÁöÑÈáëÈë∞ üö®
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDgRMrlKcBhj5_zkK3YhD24DLxmm3tEzoU",
            authDomain: "nordictravel-6feb6.firebaseapp.com",
            projectId: "nordictravel-6feb6",
            storageBucket: "nordictravel-6feb6.firebasestorage.app",
            messagingSenderId: "789294490352",
            appId: "1:789294490352:web:cc4b3570743ece12db9835",
            measurementId: "G-J48HZ2031Q",
            databaseURL: "https://nordictravel-6feb6-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };

        const GOOGLE_MAPS_API_KEY = "AIzaSyBT3is8sUrQfnLzrrde8ADK4cPx3_tImSo";
        // ==========================================

        tailwind.config = {
            theme: {
                extend: { 
                    colors: { primary: '#3B82F6', secondary: '#10B981', dark: '#1F2937', light: '#F3F4F6' },
                    boxShadow: { 'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06)' }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .weather-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tab-active { background-color: #3B82F6; color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); transform: scale(1.05); }
        .tab-inactive { background-color: #F3F4F6; color: #6B7280; }
        
        /* Map Container */
        #google-map { width: 100%; height: 100%; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* Bottom Sheet Transition */
        .sheet-transition { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1); }
    </style>
</head>
<body>

    <div id="app" class="fixed inset-0 flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden w-full z-0">
        
        <!-- Header -->
        <header class="bg-white px-5 py-4 flex justify-between items-center z-10 border-b border-gray-100 shrink-0">
            <div class="flex-1">
                <h1 class="text-xl font-bold text-gray-900 tracking-tight flex items-center">
                    {{ pageTitle }}
                    <span class="ml-2 text-[10px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded flex items-center shadow-sm">
                        <i class="fas fa-cloud mr-1"></i>Â∑≤ÂêåÊ≠•
                    </span>
                </h1>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'itinerary'">{{ daysLeftText }}</p>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'expenses'">Á∏ΩÊîØÂá∫: {{ formatMoneyEuroWithTWD(totalExpense) }}</p>
            </div>
            
            <button v-if="currentTab !== 'map'" @click="openAddModal" class="w-10 h-10 rounded-full bg-blue-50 text-primary flex items-center justify-center hover:bg-blue-100 transition shadow-sm active:scale-95">
                <i class="fas fa-plus text-lg"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50" ref="mainContainer">
            
            <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white z-50">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-3"></div>
                    <p class="text-sm text-gray-400">Ê≠£Âú®ÂêåÊ≠•Èõ≤Á´ØË≥áÊñô...</p>
                </div>
            </div>

            <!-- Tab: Itinerary -->
            <div v-if="currentTab === 'itinerary'" class="pb-24">
                <!-- Date Scroll (Sticky) -->
                <div class="sticky top-0 bg-white/95 backdrop-blur z-20 shadow-sm border-b border-gray-100">
                    <div class="flex overflow-x-auto no-scrollbar py-3 px-2 space-x-2" ref="dateScroll">
                        <button v-for="date in uniqueDates" :key="date.date"
                            @click="selectDate(date.date)"
                            :class="['flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap', 
                                     selectedDate === date.date ? 'tab-active' : 'tab-inactive hover:bg-gray-200']">
                            {{ date.display }}
                        </button>
                    </div>
                </div>

                <!-- Itinerary Container -->
                <div class="px-4 py-4 space-y-4">
                    
                    <!-- [ÈúÄÊ±Ç1] Weather Widget (‰ΩúÁÇ∫Á¨¨‰∏ÄÂÄã item, ÂèØÊªëÂãï) -->
                    <div @click="openWeatherSite" class="bg-gradient-to-r from-blue-500 to-blue-400 p-4 rounded-2xl text-white shadow-lg cursor-pointer transform transition active:scale-[0.98]">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i :class="['text-4xl mr-4 weather-icon', getWeatherIcon(currentWeather.condition)]"></i>
                                <div>
                                    <div class="text-xs font-medium opacity-90 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>{{ currentWeather.city }}</div>
                                    <div class="text-2xl font-bold">{{ currentWeather.temp }}</div>
                                    <div class="text-sm opacity-80">{{ currentWeather.condition }}</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right opacity-50"></i>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fas fa-snowflake text-4xl mb-3 opacity-30"></i>
                        <p>ÈªûÊìäÂè≥‰∏äËßí + Êñ∞Â¢ûË°åÁ®ã</p>
                    </div>

                    <!-- Timeline Items -->
                    <div v-for="item in filteredItinerary" :key="item.id" class="relative pl-6 border-l-2 border-blue-100 last:border-0">
                        <div class="absolute -left-[9px] top-3 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm"></div>
                        <div class="bg-white p-4 rounded-2xl card-shadow active:scale-[0.99] transition-transform duration-200">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-primary font-bold text-sm bg-blue-50 px-2 py-0.5 rounded">{{ item.time }}</span>
                                <div class="flex space-x-3 text-gray-400">
                                    <button @click.stop="editItem(item)" class="hover:text-primary"><i class="fas fa-pen text-xs"></i></button>
                                    <button @click.stop="deleteItem(item.id, 'itinerary')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.title }}</h3>
                            
                            <div v-if="item.location" class="flex items-center text-gray-500 text-sm mb-2 mt-2 cursor-pointer hover:text-blue-600 transition" @click="jumpToMap(item.location)">
                                <i class="fas fa-map-marker-alt text-red-400 mr-2"></i>
                                <span class="underline decoration-dotted decoration-gray-400">{{ item.location }}</span>
                                <i class="fas fa-chevron-right text-xs ml-1 opacity-50"></i>
                            </div>
                            
                            <p v-if="item.notes" class="text-gray-600 text-sm mt-2 bg-gray-50 p-2 rounded-lg leading-relaxed whitespace-pre-wrap">{{ item.notes }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Expenses -->
            <div v-if="currentTab === 'expenses'" class="pb-24">
                <div class="p-5 space-y-3">
                    <!-- User Totals -->
                    <div class="space-y-3">
                        <div v-for="user in users" :key="user" class="bg-white p-3 rounded-xl card-shadow text-left flex justify-between items-center">
                            <div class="text-sm font-medium text-gray-500">{{ user }} ‰ªòÊ¨æÁ∏ΩÈ°ç:</div>
                            <div class="text-xl font-bold text-primary">{{ formatMoneyEuro(getUserPaid(user)) }}</div>
                        </div>
                    </div>

                    <!-- Settlements -->
                    <div v-if="settlements.length" class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-green-800 flex items-center"><i class="fas fa-calculator mr-2"></i> ÂàÜÂ∏≥ÁµêÁÆó</h3>
                            <button @click="showSettlement = !showSettlement" class="text-green-600 text-sm hover:text-green-700">
                                <i :class="showSettlement ? 'fas fa-chevron-up' : 'fas fa-chevron-down']"></i>
                            </button>
                        </div>
                        <div v-if="showSettlement" class="space-y-2">
                            <div v-for="s in settlements" :key="s.from+s.to" class="flex items-center justify-between bg-white p-3 rounded-lg">
                                <div class="flex items-center">
                                    <span class="font-bold text-gray-700">{{ s.from }}</span>
                                    <i class="fas fa-arrow-right mx-3 text-green-500"></i>
                                    <span class="font-bold text-gray-700">{{ s.to }}</span>
                                </div>
                                <span class="font-bold text-green-600">{{ formatMoneyEuro(s.amount) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Expense List -->
                    <div class="space-y-2">
                        <div v-for="exp in sortedExpenses" :key="exp.id" class="bg-white p-4 rounded-xl card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">{{ exp.title }}</h4>
                                    <div class="text-xs text-gray-500 mt-1 flex items-center">
                                        <i class="far fa-calendar mr-1"></i> {{ exp.date }}
                                    </div>
                                </div>
                                <button @click="deleteItem(exp.id, 'expenses')" class="text-gray-400 hover:text-red-500 ml-2">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <div class="text-sm">
                                    <span class="text-gray-500">‰ªòÊ¨æ:</span>
                                    <span class="font-bold text-primary ml-1">{{ exp.payer }}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-800">{{ formatMoneyEuroWithTWD(exp.amount) }}</div>
                                    <div class="text-[10px] text-gray-400" v-if="exp.beneficiaries && exp.beneficiaries.length">
                                        ÂàÜÁµ¶ {{ exp.beneficiaries.join(', ') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map (Full Height) -->
            <div v-if="currentTab === 'map'" class="relative w-full h-full flex flex-col">
                <!-- Map Container -->
                <div class="flex-1 w-full h-full relative">
                    <div id="google-map" class="w-full h-full"></div>
                    <div v-if="!mapLoaded" class="absolute inset-0 flex items-center justify-center bg-gray-100/90 z-10">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
                            <p class="text-gray-500 text-sm">Âú∞ÂúñËºâÂÖ•‰∏≠...</p>
                        </div>
                    </div>
                </div>

                <!-- [ÈúÄÊ±Ç2] Bottom Sheet Location List -->
                <div 
                    class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white rounded-t-3xl shadow-up z-20 sheet-transition flex flex-col pb-safe"
                    :style="{ height: '60vh', transform: isBottomSheetOpen ? 'translateY(0)' : 'translateY(calc(100% - 70px))' }"
                >
                    <!-- Drag Handle / Header -->
                    <div @click="toggleBottomSheet" class="p-3 cursor-pointer bg-white rounded-t-3xl flex-shrink-0 border-b border-gray-100" >
                        <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                        <div class="flex justify-between items-center px-4 pb-2">
                            <h3 class="font-bold text-lg text-gray-800">ÊâÄÊúâË°åÁ®ãÂú∞Èªû ({{ uniqueLocations.length }})</h3>
                            <button class="text-gray-400 text-sm">
                                <i :class="['fas', isBottomSheetOpen ? 'fa-chevron-down' : 'fa-chevron-up']"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Location List -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
                        
                        <!-- Current Location -->
                        <button @click="focusCurrentLocation" 
                            class="w-full bg-white p-4 rounded-xl border border-blue-100 flex items-center justify-between shadow-sm active:bg-blue-50 transition">
                            <div class="flex items-center text-blue-600">
                                <i class="fas fa-location-arrow text-xl w-8 text-center"></i>
                                <span class="font-bold ml-2">ÊàëÁöÑ‰ΩçÁΩÆ</span>
                            </div>
                            <i class="fas fa-crosshairs text-blue-400"></i>
                        </button>

                        <div v-if="uniqueLocations.length === 0" class="text-center py-8 text-gray-400 text-sm">
                             Â∞öÁÑ°Âú∞ÈªûË≥áÊñô
                        </div>

                        <!-- [ÈúÄÊ±Ç3] Locations Items with Selected State -->
                        <button v-for="(loc, index) in uniqueLocations" :key="loc"
                            @click="selectLocation(loc)"
                            class="w-full p-4 rounded-xl flex items-center justify-between transition-all duration-200 border"
                            :class="selectedLocation === loc 
                                ? 'bg-blue-50 border-blue-400 ring-2 ring-blue-100 shadow-md transform scale-[1.01]' 
                                : 'bg-white border-transparent shadow-sm hover:bg-gray-50'">
                            
                            <div class="flex items-center overflow-hidden">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-3"
                                     :class="selectedLocation === loc ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'">
                                    {{ index + 1 }}
                                </div>
                                <span class="font-medium truncate flex-1 text-left"
                                      :class="selectedLocation === loc ? 'text-blue-800' : 'text-gray-700'">
                                    {{ loc }}
                                </span>
                            </div>
                            <i v-if="selectedLocation === loc" class="fas fa-check-circle text-blue-500 ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-100 py-2 px-4 flex justify-around items-center shrink-0 pb-safe z-30">
            <button @click="switchTab('itinerary')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-calendar-alt text-xl mb-1"></i>
                <span class="text-xs font-medium">Ë°åÁ®ã</span>
            </button>
            <button @click="switchTab('expenses')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'expenses' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs font-medium">ÂàÜÂ∏≥</span>
            </button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'map' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-map text-xl mb-1"></i>
                <span class="text-xs font-medium">Âú∞Âúñ</span>
            </button>
        </nav>

        <!-- Add Modal -->
        <div v-if="showAddModal" @click.self="closeModal" class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn">
            <div class="bg-white w-full rounded-t-3xl p-6 pb-safe max-h-[85vh] overflow-y-auto slide-up">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-bold text-gray-800">{{ currentTab === 'itinerary' ? (isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã') : 'Êñ∞Â¢ûÊîØÂá∫' }}</h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Êó•Êúü</label><input v-model="itineraryForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ÊôÇÈñì</label><input v-model="itineraryForm.time" type="time" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Ê®ôÈ°å</label><input v-model="itineraryForm.title" type="text" placeholder="‰æã: ÊñØÂæ∑Âì•ÁàæÊë©ËàäÂüéÂçÄ" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Âú∞Èªû</label><input v-model="itineraryForm.location" type="text" placeholder="Gamla Stan, Stockholm" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label><textarea v-model="itineraryForm.notes" rows="3" placeholder="ÂèØÈÅ∏" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea></div>
                    <button @click="saveItinerary" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        {{ isEditing ? 'Êõ¥Êñ∞' : 'Êñ∞Â¢û' }}
                    </button>
                </div>

                <div v-if="currentTab === 'expenses'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">È†ÖÁõÆ</label><input v-model="expenseForm.title" type="text" placeholder="‰æã: ÊôöÈ§ê" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈáëÈ°ç (‚Ç¨ Ê≠êÂÖÉ)</label>
                        <input v-model.number="expenseForm.amount" @input="formatEuroAmount" type="number" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                        <p class="text-xs text-gray-500 mt-1">Á¥ÑÁ≠âÊñº {{ formatMoneyEuroWithTWD(expenseForm.amount || 0) }}</p>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Êó•Êúü</label><input v-model="expenseForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰ªòÊ¨æ‰∫∫</label>
                        <div class="flex gap-2">
                            <button v-for="user in users" :key="user" @click="expenseForm.payer = user" :class="['flex-1 py-2 rounded-xl font-medium transition', expenseForm.payer === user ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂèóÁõä‰∫∫</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button v-for="user in users" :key="user" @click="toggleBeneficiary(user)" :class="['px-4 py-2 rounded-xl font-medium transition', expenseForm.beneficiaries.includes(user) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                        <button @click="toggleAllBeneficiaries" class="text-sm text-primary hover:underline">
                            {{ expenseForm.beneficiaries.length === users.length ? 'ÂèñÊ∂àÂÖ®ÈÅ∏' : 'ÂÖ®ÈÅ∏' }}
                        </button>
                    </div>
                    <button @click="saveExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        Êñ∞Â¢ûÊîØÂá∫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

        const App = {
            setup() {
                // --- Initialization ---
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const db = firebase.database();
                const itineraryRef = db.ref('itinerary');
                const expensesRef = db.ref('expenses');
                
                // --- State ---
                const loading = ref(true);
                const currentTab = ref('itinerary');
                const showAddModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const showSettlement = ref(false);
                const selectedDate = ref('');
                
                // Bottom Sheet & Map State
                const isBottomSheetOpen = ref(false);
                const selectedLocation = ref(null);
                const mapLoaded = ref(false);
                
                const users = ['Han', 'Sylvia', 'Messi', 'Cheryl'];
                const EURO_TO_TWD = 34.5;
                const mainContainer = ref(null);

                const itineraryItems = ref([]);
                const expenses = ref([]);

                const itineraryForm = reactive({ date: '', time: '09:00', title: '', location: '', notes: '' });
                const expenseForm = reactive({ title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });

                const currentWeather = reactive({ temp: 'N/A', condition: 'cloudy', city: 'Nordic' });
                
                let map = null;
                let markers = [];
                let geocoder = null;
                let userLocationMarker = null;

                // --- Computed Properties ---
                const pageTitle = computed(() => {
                    if (currentTab.value === 'itinerary') return 'ÂåóÊ≠êË°åÁ®ã';
                    if (currentTab.value === 'expenses') return 'ÂàÜÂ∏≥Âä©Êâã';
                    return 'Âú∞ÈªûÂ∞éËà™';
                });

                const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('zh-TW', { weekday: 'short' }).replace('ÊòüÊúü', 'ÈÄ±');

                const uniqueDates = computed(() => {
                    const allDates = new Set(itineraryItems.value.map(i => i.date));
                    ['2025-12-20', '2025-12-21', '2025-12-23', '2025-12-31', '2026-01-03', '2026-01-05'].forEach(d => allDates.add(d));
                    
                    return Array.from(allDates).sort().map((date, index) => {
                        return {
                            date: date,
                            display: `${new Date(date).getMonth()+1}/${new Date(date).getDate()} (${getDayName(date)})`
                        };
                    });
                });

                const filteredItinerary = computed(() => itineraryItems.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((sum, i) => sum + (Number(i.amount)||0), 0));
                const sortedExpenses = computed(() => [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)));
                const uniqueLocations = computed(() => [...new Set(itineraryItems.value.filter(i => i.location).map(i => i.location))]);
                
                const settlements = computed(() => {
                    const balance = {}; 
                    users.forEach(p => balance[p] = 0);
                    expenses.value.forEach(e => {
                        const beneficiaries = Array.isArray(e.beneficiaries) ? e.beneficiaries : [];
                        if (!beneficiaries.length || e.amount <= 0) return;
                        balance[e.payer] += e.amount;
                        const split = e.amount / beneficiaries.length;
                        beneficiaries.forEach(b => balance[b] -= split);
                    });
                    let debtors = Object.keys(balance).filter(p => balance[p] < -0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>a.a-b.a);
                    let creditors = Object.keys(balance).filter(p => balance[p] > 0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>b.a-a.a);
                    const res = [];
                    let i=0, j=0;
                    while(i<debtors.length && j<creditors.length) {
                        const amt = Math.min(Math.abs(debtors[i].a), creditors[j].a);
                        res.push({from:debtors[i].n, to:creditors[j].n, amount: parseFloat(amt.toFixed(2))});
                        debtors[i].a += amt; 
                        creditors[j].a -= amt;
                        if(Math.abs(debtors[i].a)<0.01) i++;
                        if(creditors[j].a<0.01) j++;
                    }
                    return res;
                });

                const daysLeftText = computed(() => {
                    const allDates = Array.from(new Set(itineraryItems.value.map(i => i.date))).sort();
                    const index = allDates.indexOf(selectedDate.value);
                    if (index === -1) return 'ÈùûË°åÁ®ãÊó•';
                    return `Day ${index + 1}`;
                });

                // --- Methods ---
                const updateWeather = () => {
                    let city = "Nordic";
                    let temp = "-3¬∞C";
                    let condition = "cloudy";
                    if (filteredItinerary.value.length > 0) {
                        const loc = filteredItinerary.value[0].location || "";
                        if (loc.match(/Stockholm/i)) { city = "Stockholm"; temp = "-1¬∞C"; condition = "snow"; }
                        else if (loc.match(/Helsinki/i)) { city = "Helsinki"; temp = "-5¬∞C"; condition = "snow"; }
                        else if (loc.match(/Rovaniemi/i)) { city = "Rovaniemi"; temp = "-12¬∞C"; condition = "snow"; }
                        else if (loc.match(/Oslo/i)) { city = "Oslo"; temp = "-4¬∞C"; condition = "cloudy"; }
                        else if (loc.match(/Bergen/i)) { city = "Bergen"; temp = "1¬∞C"; condition = "rain"; }
                        else if (loc.match(/Copenhagen/i)) { city = "Copenhagen"; temp = "3¬∞C"; condition = "cloudy"; }
                    }
                    currentWeather.city = city; currentWeather.temp = temp; currentWeather.condition = condition;
                };

                // --- Data Listeners ---
                const snapshotToArray = (snapshot) => {
                    const list = [];
                    snapshot.forEach(childSnapshot => {
                        list.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    return list;
                };

                const checkAndSeedData = async () => {
                    loading.value = true;
                };

                onMounted(() => {
                    checkAndSeedData();

                    if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== "") {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
                        script.async = true;
                        script.defer = true;
                        document.head.appendChild(script);
                        window.initMap = initMap;
                    }

                    itineraryRef.on('value', (snapshot) => {
                        itineraryItems.value = snapshotToArray(snapshot);
                        loading.value = false;
                        if (uniqueDates.value.length > 0 && !selectedDate.value) selectedDate.value = uniqueDates.value[0].date;
                        updateWeather();
                    });

                    expensesRef.on('value', (snapshot) => {
                        expenses.value = snapshotToArray(snapshot);
                    });
                });
                
                watch(selectedDate, () => {
                     updateWeather(); 
                     if (mainContainer.value) mainContainer.value.scrollTop = 0;
                });

                watch(uniqueLocations, () => {
                    if (map && mapLoaded.value) updateMapMarkers();
                }, { deep: true });

                const selectDate = (date) => { selectedDate.value = date; };

                // --- Google Maps Logic ---
                const initMap = () => {
                    geocoder = new google.maps.Geocoder();
                    mapLoaded.value = true;
                    // Â¶ÇÊûú‰∏ÄÈñãÂßãÂ∞±Âú® map tabÔºåÂâáÊ∏≤Êüì
                    if (currentTab.value === 'map') {
                        renderMap();
                    }
                };

                // [ÈúÄÊ±Ç4] ÈáçÊñ∞ÈªûÊìäÂú∞Âúñ tab ÊôÇÔºåÂú∞ÂúñÊ≤íÊúâÈ°ØÁ§∫Âá∫‰æÜ -> ‰øÆÊ≠£ renderMap ÈÇèËºØ
                const renderMap = () => {
                    if (!mapLoaded.value) return;
                    
                    // ‰ΩøÁî® setTimeout Á¢∫‰øù v-if DOM Â∑≤Á∂ìÁîüÊàê
                    setTimeout(() => {
                        const mapEl = document.getElementById('google-map');
                        if (mapEl) {
                            // Âç≥‰Ωø map Áâ©‰ª∂Â≠òÂú®Ôºå‰πüË¶ÅÈáçÊñ∞ new ‰∏ÄÊ¨°ÔºåÂõ†ÁÇ∫ DOM ÂÖÉÁ¥†Ë¢´ÊõøÊèõ‰∫Ü
                            map = new google.maps.Map(mapEl, {
                                center: { lat: 59.3293, lng: 18.0686 },
                                zoom: 5,
                                disableDefaultUI: true,
                                zoomControl: true,
                            });
                            updateMapMarkers();
                        }
                    }, 50);
                };

                const updateMapMarkers = () => {
                    if (!map || !geocoder) return;
                    markers.forEach(m => m.setMap(null));
                    markers = [];
                    if (userLocationMarker) userLocationMarker.setMap(null);

                    const locs = uniqueLocations.value;
                    let bounds = new google.maps.LatLngBounds();
                    
                    if (locs.length === 0) {
                        map.setCenter({ lat: 59.3293, lng: 18.0686 });
                        map.setZoom(5);
                        return;
                    }

                    locs.forEach((address, index) => {
                        geocoder.geocode({ address: address }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                const position = results[0].geometry.location;
                                const marker = new google.maps.Marker({
                                    map: map,
                                    position: position,
                                    title: address,
                                    label: { text: (index + 1).toString(), color: "white", fontSize: "12px", fontWeight: "bold" },
                                    animation: google.maps.Animation.DROP
                                });
                                
                                // ÈªûÊìä marker ‰πüÊúÉËß∏ÁôºÈÅ∏‰∏≠
                                marker.addListener('click', () => {
                                    selectLocation(address);
                                });

                                markers.push(marker);
                                bounds.extend(position);
                                
                                if (markers.length === locs.length) {
                                     // Â¶ÇÊûúÊúâÈÅ∏‰∏≠Âú∞ÈªûÔºåÂÑ™ÂÖàËÅöÁÑ¶Ë©≤Âú∞Èªû
                                     if (selectedLocation.value) {
                                         focusMap(selectedLocation.value, false);
                                     } else {
                                         map.fitBounds(bounds);
                                     }
                                }
                            }
                        });
                    });
                };
                
                const focusMap = (address, zoom = true) => {
                    if(!map || !geocoder) return;
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK') {
                            map.setCenter(results[0].geometry.location);
                            if(zoom) map.setZoom(15);
                        }
                    });
                };

                // [ÈúÄÊ±Ç3] ÈªûÊìäÊâÄÊúâË°åÁ®ãÂú∞Èªû list ÁöÑ item ÊôÇÔºåÂ∏åÊúõÊòØ selected ÁöÑÁãÄÊÖã
                const selectLocation = (loc) => {
                    selectedLocation.value = loc; // Ë®≠ÂÆöÈÅ∏‰∏≠ÁãÄÊÖã
                    focusMap(loc); // ÁßªÂãïÂú∞Âúñ
                    isBottomSheetOpen.value = false; // Êî∂Ëµ∑ Bottom Sheet (ÂèØÈÅ∏ÔºåËÆì‰ΩøÁî®ËÄÖÁúãÂú∞Âúñ)
                };

                const toggleBottomSheet = () => {
                    isBottomSheetOpen.value = !isBottomSheetOpen.value;
                };

                const focusCurrentLocation = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                            if (userLocationMarker) userLocationMarker.setMap(null);
                            userLocationMarker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                title: "Your Location",
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 },
                            });
                            map.setCenter(pos);
                            map.setZoom(15);
                            isBottomSheetOpen.value = false;
                        }, () => alert("ÁÑ°Ê≥ïÁç≤ÂèñÊÇ®ÁöÑ‰ΩçÁΩÆ"));
                    } else {
                        alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰ΩçÂäüËÉΩ");
                    }
                };

                const jumpToMap = (location) => {
                    selectedLocation.value = location; // È†êÂÖàÈÅ∏‰∏≠
                    switchTab('map');
                    // switchTab Ë£°ÁöÑ renderMap ÊúÉËôïÁêÜÂæåÁ∫åÁöÑÂú∞ÂúñÊ∏≤ÊüìÂíåËÅöÁÑ¶
                };

                const switchTab = (tab) => {
                    currentTab.value = tab;
                    if (tab === 'map') {
                        // ÊØèÊ¨°ÂàáÊèõÂà∞ mapÔºåÂº∑Âà∂ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âúñ‰ª•Ëß£Ê±∫ v-if Â∞éËá¥ÁöÑÁ©∫ÁôΩÂïèÈ°å
                        renderMap();
                        // È†êË®≠ÈóúÈñâÂàóË°®ÔºåÈú≤Âá∫Âú∞Âúñ
                        isBottomSheetOpen.value = false;
                        
                        // Â¶ÇÊûúÊúâÈ†êÈÅ∏Âú∞ÈªûÔºåÂª∂ÈÅ≤ËÅöÁÑ¶
                        if (selectedLocation.value) {
                            setTimeout(() => focusMap(selectedLocation.value), 300);
                        }
                    }
                };
                
                // --- UI Actions ---
                const openAddModal = () => {
                    itineraryForm.date = selectedDate.value;
                    showAddModal.value = true;
                };

                const closeModal = () => {
                    showAddModal.value = false; isEditing.value = false; editingId.value = null;
                    Object.assign(itineraryForm, { date: selectedDate.value, time: '09:00', title: '', location: '', notes: '' });
                    Object.assign(expenseForm, { title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });
                };

                const saveItinerary = async () => {
                    const item = { ...itineraryForm };
                    if (!item.title) return alert("Ë´ãÂ°´ÂØ´Ê®ôÈ°å");
                    try {
                        if (isEditing.value) await itineraryRef.child(editingId.value).update(item);
                        else await itineraryRef.push().set(item);
                        closeModal(); 
                    } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message); }
                };

                const saveExpense = async () => {
                    const amount = Number(parseFloat(expenseForm.amount).toFixed(2));
                    if (isNaN(amount) || amount <= 0) return alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°ç');
                    const item = { ...expenseForm, amount: amount };
                    if (!item.title) return alert("Ë´ãÂ°´ÂØ´È†ÖÁõÆ");
                    try {
                        await expensesRef.push().set(item);
                        closeModal(); 
                    } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message); }
                };

                // --- Helpers ---
                const formatMoneyEuro = (v) => new Intl.NumberFormat('en-US', {style:'currency', currency:'EUR', minimumFractionDigits:2, maximumFractionDigits:2}).format(v);
                const formatMoneyEuroWithTWD = (v) => {
                    const euro = parseFloat(v) || 0;
                    const twd = Math.round(euro * EURO_TO_TWD);
                    return `${formatMoneyEuro(euro)} (Á¥Ñ NTD ${new Intl.NumberFormat('zh-TW', {maximumFractionDigits:0}).format(twd)})`;
                };
                const formatEuroAmount = () => {
                    let value = String(expenseForm.amount).replace(/[^0-9.]/g, '');
                    const parts = value.split('.');
                    if (parts.length > 1 && parts[1].length > 2) { parts[1] = parts[1].substring(0, 2); value = parts.join('.'); }
                    expenseForm.amount = value;
                };
                const openWeatherSite = () => {
                    // ÂéüÁîüÂ§©Ê∞£ App URL Scheme (iOS)
                    window.location.href = `weather://?index=0`; 
                    // Fallback
                    setTimeout(() => window.open(`https://wttr.in/${currentWeather.city}`, '_blank'), 500);
                };
                const getWeatherIcon = (condition) => {
                    if (condition.includes('sun')) return 'fas fa-sun text-yellow-400';
                    if (condition.includes('snow')) return 'fas fa-snowflake text-blue-200';
                    if (condition.includes('rain')) return 'fas fa-cloud-rain text-blue-500';
                    return 'fas fa-cloud text-gray-400';
                };
                const getUserPaid = (u) => expenses.value.filter(e => e.payer === u).reduce((s,e) => s+e.amount, 0);
                const toggleAllBeneficiaries = () => expenseForm.beneficiaries = expenseForm.beneficiaries.length === users.length ? [] : [...users];
                const toggleBeneficiary = (u) => { const i = expenseForm.beneficiaries.indexOf(u); i>-1 ? expenseForm.beneficiaries.splice(i,1) : expenseForm.beneficiaries.push(u); };
                const deleteItem = async (id, col) => { if (confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) await db.ref(col).child(id).remove(); };
                const editItem = (item) => { isEditing.value = true; editingId.value = item.id; Object.assign(itineraryForm, { ...item }); currentTab.value = 'itinerary'; showAddModal.value = true; };

                return {
                    loading, currentTab, pageTitle, daysLeftText, users, showAddModal, isEditing, showSettlement, currentWeather, mapLoaded,
                    isBottomSheetOpen, selectedLocation, // Êñ∞Â¢ûÁöÑÁãÄÊÖã
                    uniqueDates, selectedDate, filteredItinerary, totalExpense, sortedExpenses, uniqueLocations, settlements,
                    itineraryForm, expenseForm, mainContainer,
                    selectDate, formatMoneyEuro, formatMoneyEuroWithTWD, getUserPaid, toggleAllBeneficiaries, toggleBeneficiary, closeModal, editItem, saveItinerary, deleteItem, saveExpense, getWeatherIcon,
                    formatEuroAmount, switchTab, focusMap, focusCurrentLocation, openAddModal, openWeatherSite, jumpToMap, 
                    toggleBottomSheet, selectLocation // Êñ∞Â¢ûÁöÑÊñπÊ≥ï
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>