<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æ­æ¥µå…‰ä¹‹æ—… (Realtime DB ç‰ˆ)</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase (ä½¿ç”¨ Compat ç‰ˆæœ¬ä»¥æ”¯æ´ HTML ç›´æ¥å¼•å…¥) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- æ”¹ç”¨ Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ==========================================
        // ğŸš¨ CONFIG AREA - è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„é‡‘é‘° ğŸš¨
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDgRMrlKcBhj5_zkK3YhD24DLxmm3tEzoU",
            authDomain: "nordictravel-6feb6.firebaseapp.com",
            projectId: "nordictravel-6feb6",
            storageBucket: "nordictravel-6feb6.firebasestorage.app",
            messagingSenderId: "789294490352",
            appId: "1:789294490352:web:cc4b3570743ece12db9835",
            measurementId: "G-J48HZ2031Q",
            databaseURL: "https://nordictravel-6feb6-default-rtdb.asia-southeast1.firebasedatabase.app/" 
};

        // 2. å¡«å…¥ Google Maps API Key
        const GOOGLE_MAPS_API_KEY = "AIzaSyBT3is8sUrQfnLzrrde8ADK4cPx3_tImSo";
        // ==========================================

        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#3B82F6', secondary: '#10B981', dark: '#1F2937', light: '#F3F4F6', accent: '#8B5CF6' } }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #F3F4F6; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .weather-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tab-active { background-color: #3B82F6; color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); transform: scale(1.05); }
        .tab-inactive { background-color: #F3F4F6; color: #6B7280; }

        #google-map { width: 100%; height: 100%; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        .map-number-badge {
            display: flex; align-items: center; justify-content: center;
            width: 24px; height: 24px;
            background-color: #EF4444; color: white;
            border-radius: 50%; font-size: 12px; font-weight: bold;
            margin-right: 12px; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>

    <div id="app" class="fixed inset-0 flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden w-full z-0">
        
        <!-- Config Missing Alert (ç™½å±ä¿®å¾©ï¼šå¦‚æœæ²’æœ‰è¨­å®š Keyï¼Œé¡¯ç¤ºæç¤º) -->
        <div v-if="configError" class="absolute inset-0 z-[60] bg-gray-900/90 flex items-center justify-center p-6 text-white text-center">
            <div class="space-y-4">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-400"></i>
                <h2 class="text-xl font-bold">ç¼ºå°‘ Firebase è¨­å®š</h2>
                <p class="text-sm text-gray-300">
                    ç‚ºäº†æ­£å¸¸é‹ä½œï¼Œè«‹ç·¨è¼¯æ­¤ HTML æª”æ¡ˆï¼Œ<br>
                    ä¸¦åœ¨ <code>firebaseConfig</code> å€åŸŸå¡«å…¥æ‚¨çš„ API Keyã€‚
                </p>
                <div class="text-xs bg-gray-800 p-3 rounded text-left font-mono break-all">
                    const firebaseConfig = {<br>
                    &nbsp;&nbsp;apiKey: "...",<br>
                    &nbsp;&nbsp;...<br>
                    };
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white px-5 py-4 flex justify-between items-center z-10 border-b border-gray-100 shrink-0">
            <div class="flex-1">
                <h1 class="text-xl font-bold text-gray-900 tracking-tight flex items-center">
                    {{ pageTitle }}
                    <span v-if="!loading" class="ml-2 text-[10px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded flex items-center shadow-sm">
                        <i class="fas fa-database mr-1"></i>RTDB
                    </span>
                </h1>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'itinerary'">{{ daysLeftText }}</p>
                <p class="text-xs text-gray-500 mt-0.5" v-if="currentTab === 'expenses'">ç¸½æ”¯å‡º: {{ formatMoneyEuroWithTWD(totalExpense) }}</p>
            </div>
            
            <button v-if="currentTab !== 'map'" @click="openAddModal" class="w-10 h-10 rounded-full bg-blue-50 text-primary flex items-center justify-center hover:bg-blue-100 transition shadow-sm active:scale-95">
                <i class="fas fa-plus text-lg"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50" ref="mainContainer">
            
            <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white z-50">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-3"></div>
                    <p class="text-sm text-gray-400">æ­£åœ¨é€£æ¥ Realtime Database...</p>
                    <p v-if="seedingData" class="text-xs text-blue-500 mt-2">é¦–æ¬¡åˆå§‹åŒ–è³‡æ–™ä¸­...</p>
                </div>
            </div>

            <!-- Tab: Itinerary -->
            <div v-if="currentTab === 'itinerary'" class="pb-24">
                <!-- Date Scroll -->
                <div class="sticky top-0 bg-white/95 backdrop-blur z-10 shadow-sm border-b border-gray-100">
                    <div class="flex overflow-x-auto no-scrollbar py-3 px-2 space-x-2" ref="dateScroll">
                        <button v-for="date in uniqueDates" :key="date.date"
                            @click="selectDate(date.date)"
                            :class="['flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 whitespace-nowrap', 
                                     selectedDate === date.date ? 'tab-active' : 'tab-inactive hover:bg-gray-200']">
                            {{ date.display }}
                        </button>
                    </div>

                    <!-- Weather Widget -->
                    <div @click="openWeatherSite" class="flex items-center mx-4 my-2 p-3 bg-blue-50 rounded-xl cursor-pointer hover:bg-blue-100 transition active:scale-[0.98]">
                        <i :class="['text-3xl mr-3 weather-icon', getWeatherIcon(currentWeather.condition)]"></i>
                        <div class="text-left flex-1">
                            <div class="text-sm font-medium text-gray-800">{{ currentWeather.city }} - ä»Šæ—¥æ¦‚æ³</div>
                            <div class="text-xl font-bold text-gray-900">{{ currentWeather.temp }}</div>
                        </div>
                        <i class="fas fa-external-link-alt text-gray-400 text-sm"></i>
                    </div>
                </div>

                <!-- Itinerary List -->
                <div class="px-4 py-6 space-y-4">
                    <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fas fa-snowflake text-4xl mb-3 opacity-30"></i>
                        <p>æ­¤æ—¥æœŸç„¡è¡Œç¨‹</p>
                        <p class="text-xs mt-1">é»æ“Šå³ä¸Šè§’ + æ–°å¢</p>
                    </div>

                    <div v-for="item in filteredItinerary" :key="item.id" class="relative pl-6 border-l-2 border-blue-100 last:border-0">
                        <div class="absolute -left-[9px] top-3 w-4 h-4 rounded-full bg-white border-4 border-primary shadow-sm"></div>
                        <div class="bg-white p-4 rounded-2xl card-shadow active:scale-[0.99] transition-transform duration-200">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-primary font-bold text-sm bg-blue-50 px-2 py-0.5 rounded">{{ item.time }}</span>
                                <div class="flex space-x-3 text-gray-400">
                                    <button @click="editItem(item)" class="hover:text-primary"><i class="fas fa-pen text-xs"></i></button>
                                    <button @click="deleteItem(item.id, 'itinerary')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg mb-1">{{ item.title }}</h3>
                            
                            <!-- Location -->
                            <div v-if="item.location" class="flex items-center text-gray-500 text-sm mb-2 mt-2 cursor-pointer hover:text-blue-600 transition" @click="jumpToMap(item.location)">
                                <i class="fas fa-map-marker-alt text-red-400 mr-2"></i>
                                <span class="underline decoration-dotted decoration-gray-400">{{ item.location }}</span>
                                <i class="fas fa-chevron-right text-xs ml-1 opacity-50"></i>
                            </div>
                            
                            <p v-if="item.notes" class="text-gray-600 text-sm mt-2 bg-gray-50 p-2 rounded-lg leading-relaxed whitespace-pre-wrap">{{ item.notes }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Expenses -->
            <div v-if="currentTab === 'expenses'" class="pb-24">
                <div class="p-5 space-y-3">
                    <div class="space-y-3">
                        <div v-for="user in users" :key="user" class="bg-white p-3 rounded-xl card-shadow text-left flex justify-between items-center">
                            <div class="text-sm font-medium text-gray-500">{{ user }} å…ˆå¢Šäº†:</div>
                            <div class="text-xl font-bold text-primary">{{ formatMoneyEuro(getUserPaid(user)) }}</div>
                        </div>
                    </div>

                    <div v-if="settlements.length" class="bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-green-800 flex items-center"><i class="fas fa-calculator mr-2"></i> å»ºè­°çµç®—æ–¹å¼</h3>
                            <button @click="showSettlement = !showSettlement" class="text-green-600 text-sm hover:text-green-700">
                                <i :class="showSettlement ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                            </button>
                        </div>
                        <div v-if="showSettlement" class="space-y-2">
                            <div v-for="s in settlements" :key="s.from+s.to" class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm">
                                <div class="flex items-center">
                                    <span class="font-bold text-gray-700">{{ s.from }}</span>
                                    <span class="text-gray-400 text-xs mx-2">çµ¦</span>
                                    <span class="font-bold text-gray-700">{{ s.to }}</span>
                                </div>
                                <span class="font-bold text-green-600">{{ formatMoneyEuro(s.amount) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div v-for="exp in sortedExpenses" :key="exp.id" class="bg-white p-4 rounded-xl card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">{{ exp.title }}</h4>
                                    <div class="text-xs text-gray-500 mt-1 flex items-center">
                                        <i class="far fa-calendar mr-1"></i> {{ exp.date }}
                                    </div>
                                </div>
                                <button @click="deleteItem(exp.id, 'expenses')" class="text-gray-400 hover:text-red-500 ml-2">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                                <div class="text-sm">
                                    <span class="text-gray-500">ä»˜æ¬¾:</span>
                                    <span class="font-bold text-primary ml-1">{{ exp.payer }}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-800">{{ formatMoneyEuroWithTWD(exp.amount) }}</div>
                                    <div class="text-[10px] text-gray-400" v-if="exp.beneficiaries && exp.beneficiaries.length">
                                        åˆ†çµ¦ {{ exp.beneficiaries.join(', ') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map -->
            <div v-if="currentTab === 'map'" class="h-full flex flex-col">
                <div class="shrink-0 h-1/3 overflow-y-auto no-scrollbar p-4 space-y-2 border-b border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">æ‰€æœ‰è¡Œç¨‹åœ°é»</h3>
                    <button @click="focusCurrentLocation" 
                        class="w-full bg-blue-50 p-4 rounded-xl card-shadow flex items-center justify-between hover:bg-blue-100 active:scale-95 transition border border-blue-100">
                        <div class="flex items-center text-blue-600">
                            <i class="fas fa-location-arrow text-xl mr-3" style="width: 24px; text-align: center;"></i>
                            <span class="font-bold text-left ml-3">ç›®å‰ä½ç½®</span>
                        </div>
                        <i class="fas fa-crosshairs text-blue-400 ml-2"></i>
                    </button>
                    <div v-if="uniqueLocations.length === 0" class="text-center py-5 text-gray-400 text-sm">
                         <p>å°šæœªæ–°å¢ä»»ä½•åœ°é»</p>
                    </div>
                    <button v-for="(loc, index) in uniqueLocations" :key="loc" @click="focusMap(loc)"
                        class="w-full bg-white p-4 rounded-xl card-shadow flex items-center justify-between hover:bg-gray-50 active:scale-95 transition">
                        <div class="flex items-center overflow-hidden">
                            <div class="map-number-badge">{{ index + 1 }}</div>
                            <span class="font-medium text-gray-700 text-left truncate flex-1">{{ loc }}</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs ml-2"></i>
                    </button>
                </div>
                <div class="flex-1 relative bg-gray-200">
                    <div id="google-map"></div>
                    <div v-if="!mapLoaded" class="absolute inset-0 flex items-center justify-center bg-gray-100/70 backdrop-blur-sm text-gray-500 font-medium">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mr-2"></div>
                        è¼‰å…¥åœ°åœ–ä¸­...
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-100 py-2 px-4 flex justify-around items-center shrink-0 pb-safe z-50">
            <button @click="switchTab('itinerary')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'itinerary' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-calendar-alt text-xl mb-1"></i>
                <span class="text-xs font-medium">è¡Œç¨‹</span>
            </button>
            <button @click="switchTab('expenses')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'expenses' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs font-medium">åˆ†å¸³</span>
            </button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center py-2 px-4 transition-colors', currentTab === 'map' ? 'text-primary' : 'text-gray-400']">
                <i class="fas fa-map text-xl mb-1"></i>
                <span class="text-xs font-medium">åœ°åœ–</span>
            </button>
        </nav>

        <!-- Add/Edit Modal -->
        <div v-if="showAddModal" @click.self="closeModal" class="fixed inset-0 bg-black/50 flex items-end z-[70] animate-fadeIn">
            <div class="bg-white w-full rounded-t-3xl p-6 pb-safe max-h-[85vh] overflow-y-auto slide-up">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-bold text-gray-800">{{ currentTab === 'itinerary' ? (isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹') : 'æ–°å¢æ”¯å‡º' }}</h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Itinerary Form -->
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label><input v-model="itineraryForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ™‚é–“</label><input v-model="itineraryForm.time" type="time" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ¨™é¡Œ</label><input v-model="itineraryForm.title" type="text" placeholder="ä¾‹: æ–¯å¾·å“¥çˆ¾æ‘©èˆŠåŸå€" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">åœ°é»</label><input v-model="itineraryForm.location" type="text" placeholder="Gamla Stan, Stockholm" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label><textarea v-model="itineraryForm.notes" rows="3" placeholder="å¯é¸" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea></div>
                    <button @click="saveItinerary" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        {{ isEditing ? 'æ›´æ–°' : 'æ–°å¢' }}
                    </button>
                </div>

                <!-- Expense Form -->
                <div v-if="currentTab === 'expenses'" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">é …ç›®</label><input v-model="expenseForm.title" type="text" placeholder="ä¾‹: æ™šé¤" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡ (â‚¬ æ­å…ƒ)</label>
                        <input v-model.number="expenseForm.amount" @input="formatEuroAmount" type="number" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                        <p class="text-xs text-gray-500 mt-1">ç´„ç­‰æ–¼ {{ formatMoneyEuroWithTWD(expenseForm.amount || 0) }}</p>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label><input v-model="expenseForm.date" type="date" class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾äºº</label>
                        <div class="flex gap-2">
                            <button v-for="user in users" :key="user" @click="expenseForm.payer = user" :class="['flex-1 py-2 rounded-xl font-medium transition', expenseForm.payer === user ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å—ç›Šäºº</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button v-for="user in users" :key="user" @click="toggleBeneficiary(user)" :class="['px-4 py-2 rounded-xl font-medium transition', expenseForm.beneficiaries.includes(user) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600']">{{ user }}</button>
                        </div>
                        <button @click="toggleAllBeneficiaries" class="text-sm text-primary hover:underline">
                            {{ expenseForm.beneficiaries.length === users.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}
                        </button>
                    </div>
                    <button @click="saveExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition active:scale-95">
                        æ–°å¢æ”¯å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

        const App = {
            setup() {
                // --- State ---
                const loading = ref(true);
                const seedingData = ref(false);
                const configError = ref(false); // ç™½å±ä¿®å¾©ï¼šè¿½è¹¤é…ç½®éŒ¯èª¤
                
                const currentTab = ref('itinerary');
                const showAddModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const showSettlement = ref(false);
                
                const selectedDate = ref('');
                const users = ['Han', 'Sylvia', 'Messi', 'Cheryl'];
                const EURO_TO_TWD = 34.5;
                const mainContainer = ref(null);

                const itineraryItems = ref([]);
                const expenses = ref([]);
                const mapLoaded = ref(false);

                const itineraryForm = reactive({ date: '', time: '09:00', title: '', location: '', notes: '' });
                const expenseForm = reactive({ title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });
                const currentWeather = reactive({ temp: 'N/A', condition: 'cloudy', city: 'Nordic' });
                
                // Google Maps Objects
                let map = null;
                let markers = [];
                let geocoder = null;
                let userLocationMarker = null;

                // --- Realtime Database Reference ---
                let db = null;
                let itineraryRef = null;
                let expensesRef = null;

                // --- Methods ---
                // Data Seeding (JSON import logic)
                const checkAndSeedData = async () => {
                    try {
                        const snapshot = await itineraryRef.once('value');
                        if (!snapshot.exists()) {
                            console.log("åµæ¸¬åˆ°ç„¡è³‡æ–™ï¼Œé–‹å§‹åŒ¯å…¥å®Œæ•´è¡Œç¨‹ (Realtime Database)...");
                            seedingData.value = true;
                            
                            const seedData = [
                                { date: '2025-12-20', time: '18:50', title: 'å‡ºç™¼ï¼šå°åŒ—é£›æ›¼è°·', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', notes: 'TG635 (æ³°åœ‹åœ‹éš›èˆªç©º) TPE -> BKK (21:45)' },
                                { date: '2025-12-21', time: '00:05', title: 'è½‰æ©Ÿï¼šæ›¼è°·é£›æ–¯å¾·å“¥çˆ¾æ‘©', location: 'è˜‡å‡¡ç´å¸ƒæ©Ÿå ´ (BKK)', notes: 'TG960 (æ³°åœ‹åœ‹éš›èˆªç©º) BKK -> ARN (06:45)' },
                                { date: '2025-12-21', time: '09:00', title: 'æ–¯å¾·å“¥çˆ¾æ‘©å¸‚å€ç¨æ—…', location: 'Stockholm City', notes: 'æ¢ç´¢è€åŸå€ã€ç“¦è–©æ²ˆèˆ¹åšç‰©é¤¨' },
                                { date: '2025-12-22', time: '09:00', title: 'æ–¯å¾·å“¥çˆ¾æ‘©å¸‚å€ç¨æ—…', location: 'Stockholm City', notes: 'åœ°éµè—è¡“å·¡ç¦®ã€æ”å½±åšç‰©é¤¨' },
                                { date: '2025-12-23', time: '08:20', title: 'å‰å¾€èµ«çˆ¾è¾›åŸº (æœƒåˆ)', location: 'æ–¯å¾·å“¥çˆ¾æ‘©é˜¿è˜­é”æ©Ÿå ´ (ARN)', notes: 'SK702 (SAS) ARN -> HEL (10:35)ã€‚æœ‹å‹ KL1251 13:10 æŠµé”ã€‚' },
                                { date: '2025-12-23', time: '14:00', title: 'èµ«çˆ¾è¾›åŸºå¤§æ•™å ‚èˆ‡å¸‚å€', location: 'Helsinki Cathedral', notes: 'é›†å¸‚å»£å ´ã€è¨­è¨ˆå€ã€è–èª•å¸‚é›†+æ™šé¤' },
                                { date: '2025-12-24', time: '09:50', title: 'é£›å¾€ç¾…ç“¦æ¶…ç±³', location: 'èµ«çˆ¾è¾›åŸºæ©Ÿå ´ (HEL)', notes: 'AY549 HEL -> RVN (11:10)ã€‚' },
                                { date: '2025-12-24', time: '12:00', title: 'è–èª•è€äººæ‘', location: 'Santa Claus Village', notes: 'å¯„æ˜ä¿¡ç‰‡ã€æ‹ç…§ã€‚14:40æ¥é€å»æ¥µå…‰ç»ç’ƒå±‹ã€‚' },
                                { date: '2025-12-25', time: '09:00', title: 'è–èª•è€äººæ‘ä¸€æ—¥éŠ', location: 'Santa Claus Village', notes: 'KKdayè¡Œç¨‹ã€é›ªæ©‡ã€çš‡å®®å…¬åœ’ã€‚' },
                                { date: '2025-12-26', time: '08:00', title: 'é›ªæ©‡ & æ¥µå…‰æ—¥', location: 'Nordic Unique Travels', notes: 'é›†åˆå‡ºç™¼ã€‚æ™šä¸Šé£›å¾€å¥§æ–¯é™¸ (AY536->AY919)ã€‚' },
                                { date: '2025-12-27', time: '10:00', title: 'å¥§æ–¯é™¸å¸‚å€è§€å…‰', location: 'National Museum, Oslo', notes: 'ä¸‹åˆ National Museum, Frogner Park, Aker Brygge å¤œæ™¯ã€‚' },
                                { date: '2025-12-28', time: '09:00', title: 'å¥§æ–¯é™¸æ­ŒåŠ‡é™¢èˆ‡å¸‚å€', location: 'Oslo Opera House', notes: 'MUNCH Museum, æµ·å²¸è§€æ™¯é», è–èª•å¸‚é›†ã€‚' },
                                { date: '2025-12-29', time: '10:30', title: 'å³½ç£éŠèˆ¹', location: 'RÃ¥dhusbrygge 2, Oslo', notes: '10:30-13:00 éŠèˆ¹ã€‚ä¸‹åˆå‰å¾€ Bergenã€‚' },
                                { date: '2025-12-30', time: '14:00', title: 'Holmenkollen é›ªåœ‹è·³å°', location: 'Holmenkollen Ski Jump', notes: 'æ™šé–“è¿”å›å¥§æ–¯é™¸æ©Ÿå ´æ—ä½å®¿ã€‚' },
                                { date: '2025-12-31', time: '11:05', title: 'é£›å¾€å“¥æœ¬å“ˆæ ¹ (è·¨å¹´)', location: 'å¥§æ–¯é™¸åŠ å‹’ç©†æ©æ©Ÿå ´ (OSL)', notes: 'SK1467 OSL -> CPH (12:20)ã€‚' },
                                { date: '2025-12-31', time: '20:00', title: 'æ–°æ¸¯è·¨å¹´', location: 'Nyhavn, Copenhagen', notes: 'æ¸¯é‚Šæˆ–å¸‚åºœå»£å ´è·¨å¹´ï¼Œå¤œåº—æ…¶ç¥ã€‚' },
                                { date: '2026-01-01', time: '10:00', title: 'å“¥æœ¬å“ˆæ ¹ä¸€æ—¥éŠ', location: 'Amalienborg', notes: 'ç¾…æ£®å ¡åŸå ¡ã€é˜¿é¦¬æ—å ¡å®®ã€Tivoli èŠ±åœ’ã€‚' },
                                { date: '2026-01-02', time: '09:00', title: 'ç‘å…¸é¦¬çˆ¾æ‘©ä¹‹æ—…', location: 'MalmÃ¶, Sweden', notes: 'æ­ç«è»Šå‰å¾€ï¼Œåƒè§€éš†å¾·å¤§æ•™å ‚ã€‚' },
                                { date: '2026-01-03', time: '10:00', title: 'é¦¬çˆ¾æ‘©è§€å…‰', location: 'Turning Torso, MalmÃ¶', notes: 'æ—‹è½‰å¤§æ¨“ã€Malmo Castleã€‚ä¸‹åˆå‰å¾€æ©Ÿå ´ã€‚' },
                                { date: '2026-01-03', time: '18:00', title: 'å›ç¨‹ï¼šå“¥æœ¬å“ˆæ ¹é£›åŒ—äº¬', location: 'å“¥æœ¬å“ˆæ ¹æ©Ÿå ´ (CPH)', notes: 'CA878 (åœ‹èˆª) CPH -> PEK (09:45+1)ã€‚æœ‹å‹çºŒç•™å“¥æœ¬å“ˆæ ¹é€› Tivoliã€‚' },
                                { date: '2026-01-04', time: '09:45', title: 'æŠµé”åŒ—äº¬è½‰æ©Ÿ', location: 'åŒ—äº¬é¦–éƒ½åœ‹éš›æ©Ÿå ´ (PEK)', notes: 'ç­‰å¾…è½‰æ©Ÿã€‚' },
                                { date: '2026-01-05', time: '08:20', title: 'å›ç¨‹ï¼šåŒ—äº¬é£›å°åŒ—', location: 'åŒ—äº¬é¦–éƒ½åœ‹éš›æ©Ÿå ´ (PEK)', notes: 'CA185 PEK -> TPE (11:40)ã€‚' }
                            ];

                            // Batch update for Realtime DB
                            const updates = {};
                            seedData.forEach(item => {
                                const newKey = itineraryRef.push().key;
                                updates['/itinerary/' + newKey] = item;
                            });
                            
                            await db.ref().update(updates);
                            seedingData.value = false;
                        }
                    } catch (e) {
                        console.error("Seeding error:", e);
                        seedingData.value = false;
                    }
                };

                // --- Computed Properties ---
                const pageTitle = computed(() => {
                    if (currentTab.value === 'itinerary') return 'åŒ—æ­è¡Œç¨‹';
                    if (currentTab.value === 'expenses') return 'åˆ†å¸³åŠ©æ‰‹';
                    return 'åœ°é»å°èˆª';
                });

                const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('zh-TW', { weekday: 'short' }).replace('æ˜ŸæœŸ', 'é€±');

                const uniqueDates = computed(() => {
                    const allDates = new Set(itineraryItems.value.map(i => i.date));
                    ['2025-12-20', '2025-12-21', '2025-12-23', '2025-12-31', '2026-01-03', '2026-01-05'].forEach(d => allDates.add(d));
                    
                    return Array.from(allDates).sort().map((date, index) => {
                        const dayNumber = index + 1;
                        return { date, display: `${new Date(date).getMonth()+1}/${new Date(date).getDate()} (${getDayName(date)}) D${dayNumber}` };
                    });
                });

                const filteredItinerary = computed(() => itineraryItems.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((sum, i) => sum + (Number(i.amount)||0), 0));
                const sortedExpenses = computed(() => [...expenses.value].sort((a,b) => new Date(b.date) - new Date(a.date)));
                const uniqueLocations = computed(() => [...new Set(itineraryItems.value.filter(i => i.location).map(i => i.location))]);
                
                const settlements = computed(() => {
                    const balance = {}; 
                    users.forEach(p => balance[p] = 0);
                    expenses.value.forEach(e => {
                        const beneficiaries = Array.isArray(e.beneficiaries) ? e.beneficiaries : [];
                        if (!beneficiaries.length || e.amount <= 0) return;
                        balance[e.payer] += e.amount;
                        const split = e.amount / beneficiaries.length;
                        beneficiaries.forEach(b => balance[b] -= split);
                    });
                    let debtors = Object.keys(balance).filter(p => balance[p] < -0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>a.a-b.a);
                    let creditors = Object.keys(balance).filter(p => balance[p] > 0.01).map(p => ({n:p, a:balance[p]})).sort((a,b)=>b.a-a.a);
                    const res = [];
                    let i=0, j=0;
                    while(i<debtors.length && j<creditors.length) {
                        const amt = Math.min(Math.abs(debtors[i].a), creditors[j].a);
                        res.push({from:debtors[i].n, to:creditors[j].n, amount: parseFloat(amt.toFixed(2))});
                        debtors[i].a += amt; 
                        creditors[j].a -= amt;
                        if(Math.abs(debtors[i].a)<0.01) i++;
                        if(creditors[j].a<0.01) j++;
                    }
                    return res;
                });

                const daysLeftText = computed(() => {
                    const index = Array.from(new Set(itineraryItems.value.map(i => i.date))).sort().indexOf(selectedDate.value);
                    return index === -1 ? 'éè¡Œç¨‹æ—¥' : `ç¬¬ ${index + 1} å¤©`;
                });

                // --- Lifecycle ---
                onMounted(() => {
                    // 1. Check Config exists
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "") {
                        configError.value = true;
                        loading.value = false;
                        return;
                    }

                    // 2. Initialize Firebase
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    
                    // Switch to Realtime Database
                    db = firebase.database();
                    itineraryRef = db.ref('itinerary');
                    expensesRef = db.ref('expenses');

                    // 3. Init Listeners
                    checkAndSeedData();

                    // Itinerary Listener
                    itineraryRef.on('value', snapshot => {
                        const data = snapshot.val();
                        if (data) {
                            // Convert Object { key: val } to Array [{ id: key, ...val }]
                            itineraryItems.value = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
                        } else {
                            itineraryItems.value = [];
                        }
                        
                        loading.value = false;
                        if (uniqueDates.value.length > 0 && !selectedDate.value) {
                             selectedDate.value = uniqueDates.value[0].date;
                        }
                        updateWeather();
                    });

                    // Expenses Listener
                    expensesRef.on('value', snapshot => {
                        const data = snapshot.val();
                        if (data) {
                            expenses.value = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
                        } else {
                            expenses.value = [];
                        }
                    });

                    // Google Maps
                    if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== "") {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
                        script.async = true; script.defer = true;
                        document.head.appendChild(script);
                        window.initMap = initMap;
                    }
                });
                
                // --- Watchers & Helpers ---
                const updateWeather = () => {
                    let city = "Nordic", temp = "-3Â°C", condition = "cloudy";
                    if (filteredItinerary.value.length > 0) {
                        const loc = filteredItinerary.value[0].location || "";
                        if (loc.match(/Stockholm|æ–¯å¾·å“¥çˆ¾æ‘©|ARN/i)) { city = "Stockholm"; temp = "-1Â°C"; condition = "snow"; }
                        else if (loc.match(/Helsinki|èµ«çˆ¾è¾›åŸº|HEL/i)) { city = "Helsinki"; temp = "-5Â°C"; condition = "snow"; }
                        else if (loc.match(/Rovaniemi|ç¾…ç“¦æ¶…ç±³|RVN|è–èª•è€äºº/i)) { city = "Rovaniemi"; temp = "-12Â°C"; condition = "snow"; }
                        else if (loc.match(/Oslo|å¥§æ–¯é™¸|OSL/i)) { city = "Oslo"; temp = "-4Â°C"; condition = "cloudy"; }
                        else if (loc.match(/Bergen|å‘çˆ¾æ ¹|BGO/i)) { city = "Bergen"; temp = "1Â°C"; condition = "rain"; }
                        else if (loc.match(/Copenhagen|å“¥æœ¬å“ˆæ ¹|CPH/i)) { city = "Copenhagen"; temp = "3Â°C"; condition = "cloudy"; }
                        else if (loc.match(/Taipei|TPE|å°åŒ—/i)) { city = "Taipei"; temp = "18Â°C"; condition = "rain"; }
                        else if (loc.match(/Bangkok|BKK|æ›¼è°·/i)) { city = "Bangkok"; temp = "30Â°C"; condition = "sunny"; }
                        else if (loc.match(/Beijing|PEK|åŒ—äº¬/i)) { city = "Beijing"; temp = "0Â°C"; condition = "mist"; }
                    }
                    currentWeather.city = city; currentWeather.temp = temp; currentWeather.condition = condition;
                };

                watch(selectedDate, () => { updateWeather(); if (mainContainer.value) mainContainer.value.scrollTop = 0; });
                watch(uniqueLocations, () => { if (map && mapLoaded.value) updateMapMarkers(); }, { deep: true });

                const selectDate = (date) => { selectedDate.value = date; };

                // Map Logic
                const initMap = () => { geocoder = new google.maps.Geocoder(); mapLoaded.value = true; };
                const renderMap = () => {
                    if (!mapLoaded.value) return; 
                    if (!map && document.getElementById('google-map')) {
                        map = new google.maps.Map(document.getElementById('google-map'), { center: { lat: 59.3293, lng: 18.0686 }, zoom: 5, disableDefaultUI: true, zoomControl: true });
                        updateMapMarkers();
                    } else if (map) { updateMapMarkers(); }
                };
                const updateMapMarkers = () => {
                    if (!map || !geocoder) return;
                    markers.forEach(m => m.setMap(null)); markers = [];
                    if (userLocationMarker) userLocationMarker.setMap(null);
                    const locs = uniqueLocations.value;
                    let bounds = new google.maps.LatLngBounds();
                    if (locs.length === 0) return;
                    locs.forEach((address, index) => {
                        setTimeout(() => { 
                            geocoder.geocode({ address: address }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    const position = results[0].geometry.location;
                                    const marker = new google.maps.Marker({ map: map, position: position, title: address, label: { text: (index + 1).toString(), color: "white", fontSize: "12px", fontWeight: "bold" }, animation: google.maps.Animation.DROP });
                                    markers.push(marker); bounds.extend(position);
                                    if (locs.length > 1) map.fitBounds(bounds); else { map.setCenter(position); map.setZoom(15); }
                                }
                            });
                        }, index * 200);
                    });
                };
                const focusMap = (address) => {
                    if(!map || !geocoder) return;
                    geocoder.geocode({ address: address }, (r, s) => { if (s === 'OK') { map.setCenter(r[0].geometry.location); map.setZoom(15); }});
                };
                const focusCurrentLocation = () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                            if (userLocationMarker) userLocationMarker.setMap(null);
                            userLocationMarker = new google.maps.Marker({ position: pos, map: map, title: "Your Location", icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 } });
                            map.setCenter(pos); map.setZoom(15);
                        }, () => alert("ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®"));
                    } else alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
                };
                const jumpToMap = (location) => { switchTab('map'); setTimeout(() => { focusMap(location); }, 500); };
                const switchTab = (tab) => { currentTab.value = tab; if (tab === 'map') setTimeout(renderMap, 100); };
                
                // CRUD Actions
                const openAddModal = () => { itineraryForm.date = selectedDate.value; showAddModal.value = true; };
                const closeModal = () => {
                    showAddModal.value = false; isEditing.value = false; editingId.value = null;
                    Object.assign(itineraryForm, { date: selectedDate.value, time: '09:00', title: '', location: '', notes: '' });
                    Object.assign(expenseForm, { title: '', amount: '', date: new Date().toISOString().split('T')[0], payer: users[0], beneficiaries: [...users] });
                };

                const saveItinerary = async () => {
                    const item = { ...itineraryForm };
                    if (!item.title) return alert("è«‹å¡«å¯«æ¨™é¡Œ");
                    try {
                        if (isEditing.value) await itineraryRef.child(editingId.value).update(item);
                        else await itineraryRef.push(item);
                        closeModal(); 
                    } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
                };

                const saveExpense = async () => {
                    const amount = Number(parseFloat(expenseForm.amount).toFixed(2));
                    if (isNaN(amount) || amount <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                    const item = { ...expenseForm, amount: amount };
                    if (!item.title) return alert("è«‹å¡«å¯«é …ç›®");
                    try {
                        await expensesRef.push(item);
                        closeModal(); 
                    } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
                };

                const deleteItem = async (id, type) => {
                    if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                        const ref = type === 'itinerary' ? itineraryRef : expensesRef;
                        await ref.child(id).remove();
                    }
                };

                const editItem = (item) => { isEditing.value = true; editingId.value = item.id; Object.assign(itineraryForm, { ...item }); currentTab.value = 'itinerary'; showAddModal.value = true; };

                // Helpers
                const formatMoneyEuro = (v) => new Intl.NumberFormat('en-US', {style:'currency', currency:'EUR', minimumFractionDigits:2}).format(v);
                const formatMoneyEuroWithTWD = (v) => { const euro = parseFloat(v) || 0; return `${formatMoneyEuro(euro)} (ç´„ NTD ${new Intl.NumberFormat('zh-TW', {maximumFractionDigits:0}).format(Math.round(euro * EURO_TO_TWD))})`; };
                const formatEuroAmount = () => { let v = String(expenseForm.amount).replace(/[^0-9.]/g, ''); const p = v.split('.'); if (p.length > 1 && p[1].length > 2) { p[1] = p[1].substring(0, 2); v = p.join('.'); } expenseForm.amount = v; };
                const openWeatherSite = () => window.open(`https://wttr.in/${currentWeather.city}`, '_blank');
                const getWeatherIcon = (c) => { if (c.includes('sun')) return 'fas fa-sun text-yellow-400'; if (c.includes('snow')) return 'fas fa-snowflake text-blue-200'; if (c.includes('rain')) return 'fas fa-cloud-rain text-blue-500'; return 'fas fa-cloud text-gray-400'; };
                const getUserPaid = (u) => expenses.value.filter(e => e.payer === u).reduce((s,e) => s+e.amount, 0);
                const toggleAllBeneficiaries = () => expenseForm.beneficiaries = expenseForm.beneficiaries.length === users.length ? [] : [...users];
                const toggleBeneficiary = (u) => { const i = expenseForm.beneficiaries.indexOf(u); i>-1 ? expenseForm.beneficiaries.splice(i,1) : expenseForm.beneficiaries.push(u); };

                return {
                    loading, seedingData, configError, currentTab, pageTitle, daysLeftText, users, showAddModal, isEditing, showSettlement, currentWeather, mapLoaded,
                    uniqueDates, selectedDate, filteredItinerary, totalExpense, sortedExpenses, uniqueLocations, settlements,
                    itineraryForm, expenseForm, mainContainer,
                    selectDate, formatMoneyEuro, formatMoneyEuroWithTWD, getUserPaid, toggleAllBeneficiaries, toggleBeneficiary, closeModal, editItem, saveItinerary, deleteItem, saveExpense, getWeatherIcon,
                    formatEuroAmount, switchTab, focusMap, focusCurrentLocation, openAddModal, openWeatherSite, jumpToMap
                };
            }
        };

        createApp(App).mount('#app');
    </script>
</body>
</html>